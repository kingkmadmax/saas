(function(g){var window=this;'use strict';var edU=function(b){const R=new g.Uw("und",new g.Ft("Default","und",!0));R.captionTracks=b.captionTracks;return R},OIz=function(b){return new g.Pj(function(R,h){let K=b.length;
const I=[];if(K){var N=function(a,v){K--;I[a]=v;K==0&&R(I)},p=function(a){h(a)};
for(let a=0;a<b.length;a++){var l=b[a];g.rq(l,g.Lw(N,a),p)}}else R(I)})},t4=function(b){return g.so((0,g.WoP)(),b)},Qht=function({type:b,
payload:R}){b={type:b};R!==void 0&&(b.payload=R);return b},j6=function(b){b=b.key||b.id;
if(!b)throw Error("Entity key is missing");return b},xK2=function(){if(A4)return A4();
A4=g.HW("PersistentEntityStoreDb",{fX:{EntityStore:{JZ:1},EntityAssociationStore:{JZ:2}},shared:!1,upgrade(b,R){R(1)&&g.F_(g.Lk(b,"EntityStore",{keyPath:"key"}),"entityType","entityType");R(2)&&(b=g.Lk(b,"EntityAssociationStore",{keyPath:["parentEntityKey","childEntityKey"]}),g.F_(b,"byParentEntityKey","parentEntityKey"),g.F_(b,"byChildEntityKey","childEntityKey"))},version:3});return A4()},mKn=function(b){return g.so(xK2(),b)},PJn=function(b){return b instanceof Error?new ik("UNKNOWN_ENCODE_ERROR",
{originalMessage:b.message}):new ik("UNKNOWN_ENCODE_ERROR")},ZIp=function(b){return b instanceof Error?new ik("UNKNOWN_DECODE_ERROR",{originalMessage:b.message}):new ik("UNKNOWN_DECODE_ERROR")},crH=function(b,R){b=b instanceof ik?b:R(b);
g.X(b);throw b;},uzR=function(b,R,h){try{return b.X(R,h)}catch(K){crH(K,PJn)}},zA=function(b){b=(new TextEncoder).encode(b).subarray(0,16);
const R=new Uint8Array(16);R.set(b);return R},VWR=function(b){const R=X$z[b];
if(R)return R;g.kJ(new g.A$("Entity model not found.",{entityType:b}))},GA=function(b,R){a:{b=UL(b.Y,R.version);
try{var h=b.Y(R.data,R.key);break a}catch(K){crH(K,ZIp)}h=void 0}return h},gg=function(b,R,h){return b.G.objectStore("EntityStore").get(R).then(K=>{if(K){if(h&&K.entityType!==h)throw Error("Incorrect entity type");
return GA(b,K)}})},WV=function(b,R,h){return h?(h=h.map(K=>gg(b,K,R)),g.cL.all(h)):b.G.objectStore("EntityStore").index("entityType").getAll(IDBKeyRange.only(R)).then(K=>K.map(I=>GA(b,I)))},MWt=function(b,R,h){const K=j6(R);
return S6(b,K).then(()=>CJ3(b,R,h))},nN=function(b,R,h){let K=b.X[h];
K||(K=new Set,b.X[h]=K);K.add(R)},EL=function(b,R,h){const K=j6(R),I=UL(b.Y,1),N={...R};
return b.G.objectStore("EntityStore").get(K).then(p=>{if(p){if(p.entityType!==h)throw Error("Incorrect entity type");N.entityMetadata||(p=GA(b,p),N.entityMetadata=p.entityMetadata)}}).then(()=>{const p={key:K,
entityType:h,data:uzR(I,N,K),version:1};return g.cL.all([b.G.objectStore("EntityStore").put(p),MWt(b,N,h)])}).then(()=>{nN(b,K,h);
return K})},TA=function(b,R,h){R=R.map(K=>EL(b,K,h));
return g.cL.all(R)},L5U=function(b,R,h){if(h.has(R))return g.cL.resolve(void 0);
h.add(R);return rrp(b,R).then(K=>b.G.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(R)).then(()=>K)).then(K=>{let I=g.cL.resolve(void 0);
for(const N of K)I=I.then(()=>L5U(b,N,h));
return I}).then(()=>{})},J4=function(b,R,h){if(h?.hm){const I=new Set;
return L5U(b,R,I).then(()=>{const N=[];for(const p of I)N.push(J4(b,p));return g.cL.all(N).then(()=>{})})}const K=g.WJ(R).entityType;
return g.cL.all([b.G.objectStore("EntityStore").delete(R),S6(b,R)]).then(()=>{nN(b,R,K)})},S6=function(b,R){return b.G.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(R))},kx=function(b,R){return g.h7(b.G.objectStore("EntityStore").index("entityType"),{query:IDBKeyRange.only(R)},h=>g.cL.all([h.delete(),
S6(b,h.cursor.primaryKey)]).then(()=>{nN(b,h.cursor.primaryKey,R);return g.by(h)}))},w$3=function(b,R,h,K){const I=UL(b.Y,1);
return gg(b,R,K).then(N=>{if(N){N=g.s0(N,h);var p={key:R,entityType:K,data:uzR(I,N,R),version:1};return g.cL.all([b.G.objectStore("EntityStore").put(p),MWt(b,N,K)])}}).then(()=>{nN(b,R,K);
return R})},CJ3=function(b,R,h){const K=j6(R);
h=VWR(h);if(!h)return g.cL.resolve([]);R=new h(R);b=b.G.objectStore("EntityAssociationStore");h=[];for(const I of R.Y())h.push(b.put({parentEntityKey:K,childEntityKey:I}));return g.cL.all(h).then(I=>I.map(N=>N[1]))},rrp=function(b,R){const h=b.G.objectStore("EntityAssociationStore");
return h.index("byParentEntityKey").getAll(IDBKeyRange.only(R)).then(K=>{const I=[];for(const N of K)I.push(h.index("byChildEntityKey").getAll(N.childEntityKey));return g.cL.all(I)}).then(K=>{const I=[];
for(const N of K)N.length===1&&I.push(N[0].childEntityKey);return I})},UL=function(b,R=0){b=b.G[R];
if(!b)throw R=new ik("INVALID_ENCODER_VERSION",{EL:R}),g.X(R),R;return b},F53=function(b,R){for(const h of b.observers)h(R)},Yx=async function(b,R,h){var K=await mKn(b.token);
let I;R=await g.r8(K,["EntityStore","EntityAssociationStore"],R,N=>{I=new occ(N,b.G);return h(I)});
I&&(K=I.X,Object.keys(K).length>0&&(b.channel.postMessage(K),F53(b,K)));return R},e6=function(b,R,h){return Yx(b,{mode:"readwrite",
oT:!0},K=>EL(K,R,h))},DKz=function(b,R){return Yx(b,{mode:"readwrite",
oT:!0},h=>TA(h,R,"offlineOrchestrationActionWrapperEntity"))},OL=function(b,R){return Yx(b,{mode:"readwrite",
oT:!0},h=>J4(h,R))},b83=function(b){return Yx(b,{mode:"readwrite",
oT:!0},R=>kx(R,"videoPlaybackPositionEntity"))},Q2=function(b,R,h){return Yx(b,{mode:"readonly",
oT:!0},K=>gg(K,R,h))},xx=function(b,R,h){return Yx(b,{mode:"readonly",
oT:!0},K=>WV(K,R,h))},K$z=async function(){try{const R=await g.BW();
if(R&&g.j5()&&typeof g.JD.BroadcastChannel!=="undefined"){var b=new R$n;return new h$U(R,b)}}catch(R){R instanceof Error&&g.X(R)}},PV=function(){mT||(mT=K$z());
return mT},sa3=function(b){b=b.options?.persistenceOption;
return b==="ENTITY_PERSISTENCE_OPTION_PERSIST"||b==="ENTITY_PERSISTENCE_OPTION_INMEMORY_AND_PERSIST"},$Zn=async function(b){const R=await PV();
R&&await Yx(R,"readwrite",h=>{const K={};for(const I of b){if(!I.entityKey||!sa3(I))continue;const N=g.Cr(I.payload);let p=void 0;I.type==="ENTITY_MUTATION_TYPE_REPLACE"&&(p=()=>EL(h,I.payload[N],N));
I.type==="ENTITY_MUTATION_TYPE_DELETE"&&(p=()=>J4(h,I.entityKey));
I.type==="ENTITY_MUTATION_TYPE_UPDATE"&&(p=()=>w$3(h,I.entityKey,I.payload[N],N));
p&&(K[I.entityKey]=K[I.entityKey]?K[I.entityKey].then(p):p())}return g.cL.all(Object.values(K))})},Zf=async function(b){!(b=b.mutations)||b.length<=0||(g.NF&&g.NF.dispatch(Qht({type:"ENTITY_LOADED",
payload:b})),await $Zn(b),b.length=0)},Iz3=function(b){return b!==void 0},NPz=function(b){var R=g.ZL();
R=Object.assign({},R);b=Object.assign({},b);for(const h in R)b[h]?(R[h]!==4&&(R[h]=b[h]),delete b[h]):R[h]!==2&&(R[h]=4);Object.assign(R,b);g.TtD(R);JSON.stringify(R);return R},pNr=async function(b){const R=await g.BW();
return R?g.r8(await g.X2(R),["index","media","captions"],{mode:"readwrite",oT:!0},h=>{const K=IDBKeyRange.bound(b+"|",b+"~");h=[h.objectStore("index").delete(K),h.objectStore("media").delete(K),h.objectStore("captions").delete(K)];return g.cL.all(h).then(()=>{})}):void 0},lz3=async function(){const b=await g.BW();
if(!b)throw g.Zm("rvdfd");return g.r8(await g.X2(b),["index","media"],{mode:"readwrite",oT:!0},R=>{const h={};return g.Dm(R.objectStore("index"),{},K=>{var I=K.cursor.key.match(/^([\w\-_]+)\|(a|v)$/);let N=g.cL.resolve(void 0);if(I){const p=I[1];I=I[2];h[p]=h[p]||{};h[p][I]=g.erx(K.getValue()?.fmts)}else N=K.delete().then(()=>{});
return g.cL.all([g.by(K),N]).then(([p])=>p)}).then(()=>{const K={};
for(const N of Object.keys(h)){const p=h[N].v;K[N]=h[N].a&&p?1:2}const I=NPz(K);return g.O82(R.objectStore("media"),{},N=>{const p=N.cursor.key.match(g.m1x);p&&K[p[1]]||R.objectStore("media").delete(N.cursor.key);return g.W$H(N)}).then(()=>I)})})},azn=async function(b,R){var h=await g.BW();
if(!h)throw g.Zm("wct");h=await g.X2(h);await g.r8(h,["captions"],{mode:"readwrite",oT:!0},K=>{const I=[];K=K.objectStore("captions");for(let N=0;N<R.length;N++){const p=K.put(R[N],b+"|"+R[N].metadata.vss_id);I.push(p)}return g.cL.all(I)})},v6U=async function(b){b=IDBKeyRange.bound(b+"|",b+"~");
const R=await g.BW();if(!R)throw g.Zm("gactfv");return(await g.X2(R)).getAll("captions",b)},BPU=async function(b){g.uv(b,0);
return pNr(b)},H8x=function(b){return{context:g.lM(),
videoIds:b}},quz=function(b){return{context:g.lM(),
playlistIds:b}},dZ2=function(b){return{context:g.lM(),
offlinePlaylistSyncChecks:b}},y9r=function(){cV||(cV=new fzn);
return cV},tCH=function(b,R){return{eventType:{flowEventNamespace:"FLOW_EVENT_NAMESPACE_OFFLINE_ORCHESTRATION",
flowEventType:b},metadata:R,statusCode:void 0,csn:void 0,can:void 0}},ja2=function(b,R,h){h||(h=b.G.get("FLOW_TYPE_OFFLINE_ORCHESTRATION"),h||(h=g.yM(16),b.G.set("FLOW_TYPE_OFFLINE_ORCHESTRATION",h)));
b={flowNonce:h,flowType:"FLOW_TYPE_OFFLINE_ORCHESTRATION",flowEventType:R.eventType};R.metadata&&(b.flowMetadata=R.metadata);R.statusCode!==void 0&&(b.flowEventStatus=R.statusCode);R.csn&&(b.csn=R.csn);R.can&&(b.can=R.can);g.yp("flowEvent",b,void 0)},A9U=async function(b){var R=await Yx(b,{mode:"readonly",
oT:!0},d=>WV(d,"playbackData").then(t=>{var S=t.map(Q=>Q.transfer).filter(Q=>!!Q),J=t.map(Q=>Q.offlineVideoPolicy).filter(Q=>!!Q),e=t.filter(Q=>!!Q.key).map(Q=>g.Su(g.WJ(Q.key).entityId,"downloadStatusEntity"));
S=WV(d,"transfer",S);J=WV(d,"offlineVideoPolicy",J);e=WV(d,"downloadStatusEntity",e);const Y=S.then(Q=>{Q=Q.reduce((P,$B)=>{$B?.offlineVideoStreams&&P.push(...$B.offlineVideoStreams);return P},[]).filter(P=>!!P);
return WV(d,"offlineVideoStreams",Q)});
return g.cL.all([S,J,Y,e]).then(([Q,P,$B,IK])=>[t,Q,P,$B,IK])}));
b=await Yx(b,{mode:"readonly",oT:!0},d=>WV(d,"mainDownloadsListEntity").then(t=>t[0]?.downloads??[]));
const [h,K,I,N,p]=R,l={},a={},v={},B={},H={};R=[];for(var q of K)q&&(l[q.key]=q);for(const d of I)d&&(a[d.key]=d);for(const d of p)d&&(v[d.key]=d);for(const d of N)d&&(B[d.key]=d);for(const d of b)H[d.videoItem??""]=!0,d.videoItem&&(q=g.WJ(d.videoItem)?.entityId??"",R.push({externalVideoId:q}));return{offlineVideos:h.filter(d=>{if(!d||!d.key||!d.offlineVideoPolicy)return!1;d=g.WJ(d.key).entityId;d=g.Su(d,"downloadStatusEntity");return!(d&&v[d]?.downloadState==="DOWNLOAD_STATE_USER_DELETED")}).map(d=>
{var t=l[d.transfer];
const S=[];if(t?.offlineVideoStreams)for(var J of t.offlineVideoStreams){var e=B[J];e&&S.push(e)}J=a[d.offlineVideoPolicy];e=d?.playerResponseTimestamp;var Y=g.WJ(J.key).entityId;d=g.Su(Y,"mainVideoEntity");if(J.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"){var Q="OFFLINE_VIDEO_STATE_DISABLED";J.expirationTimestamp&&Number(J.expirationTimestamp)<Date.now()/1E3&&(Q="OFFLINE_VIDEO_STATE_EXPIRED")}else if(J.action==="OFFLINE_VIDEO_POLICY_ACTION_DOWNLOAD_FAILED")Q="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";
else{switch(t?.transferState){case "TRANSFER_STATE_TRANSFER_IN_QUEUE":Q="OFFLINE_VIDEO_STATE_PENDING";break;case "TRANSFER_STATE_TRANSFERRING":Q="OFFLINE_VIDEO_STATE_TRANSFERRING";break;case "TRANSFER_STATE_PAUSED_BY_USER":Q="OFFLINE_VIDEO_STATE_PAUSED_TRANSFER";break;case "TRANSFER_STATE_FAILED":Q="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";break;case "TRANSFER_STATE_COMPLETE":Q="OFFLINE_VIDEO_STATE_PLAYABLE";break;case "TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH":Q="OFFLINE_VIDEO_STATE_STREAMS_OUT_OF_DATE";
break;default:Q="OFFLINE_VIDEO_STATE_UNKNOWN"}if(Q==="OFFLINE_VIDEO_STATE_OFFLINE_FAILED")switch(t?.failureReason){case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":Q="OFFLINE_VIDEO_STATE_OUT_OF_STORAGE_ERROR";break;case "TRANSFER_FAILURE_REASON_STREAM_MISSING":Q="OFFLINE_VIDEO_STATE_STREAMS_MISSING";break;case "TRANSFER_FAILURE_REASON_NETWORK":case "TRANSFER_FAILURE_REASON_NETWORK_LOST":Q="OFFLINE_VIDEO_STATE_NETWORK_ERROR"}}Y={id:Y,videoState:Q};
t?.cotn&&(Y.cotn=t.cotn);t?.maximumDownloadQuality&&(Y.selectedVideoQuality=t?.maximumDownloadQuality);t?.lastProgressTimeMs&&(Y.lastProgressTimeMs=t.lastProgressTimeMs);e&&(Y.playerResponseSavedTimeMs=String(Number(e)*1E3));t=String;e=0;for(const P of S)if(P.streamsProgress)for(const $B of P.streamsProgress)e+=Number($B.numBytesDownloaded??0);Y.downloadedBytes=t(e);Y.selectedOfflineMode=H[d]?"OFFLINE_MODE_TYPE_AUTO_OFFLINE":"OFFLINE_NOW";J.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"&&(Y.offlinePlaybackDisabledReason=
J.offlinePlaybackDisabledReason);return Y}),
additionalOfflineClientState:{mainAppAdditionalOfflineClientState:{smartDownloadVideos:R}}}},z$U=function(){try{let h=g.YB("ytglobal.locks_");
if(h)return h;var b;if(b=navigator){var R=navigator;b="locks"in R&&!!R.locks}if(b)return g.JD.localStorage&&g.JD.localStorage.getItem("noop"),h=new i8c,g.kB("ytglobal.locks_",h),h}catch{}},uk=function(b){if(b.includes(":"))throw Error(`Invalid user cache name: ${b}`);
return`${b}:${g.t$("CacheStorage get")}`},UZn=async function(){return XL!==void 0?XL:XL=new Promise(async b=>{try{await V2.open("test-only"),await V2.delete("test-only")}catch(R){if(R instanceof Error&&R.name==="SecurityError"){b(!1);
return}}b("caches"in window)})},M4=async function(){if(await UZn())return CN||(CN=new Gon),CN},rg=function(b,R,h){g.kJ(new g.A$(`Woffle: ${b}`,h?{cotn:h}:""));
R instanceof Error&&g.kJ(R)},g6c=async function(b){b=await A9U(b);
g.yp("offlineStateSnapshot",b)},LN=function(b,R){g.rw(b.api,"onOfflineOperationFailure",R);
b.G?.postMessage(R)},W$z=function(b){if(!b.X&&!b.G){var R=z$U();
if(R){b.X=!0;var h=g.t$("OfflineLockManager");R.request(`${"woffle_orchestration_leader"}:${h}`,{},async()=>{try{b.Y=new g.d$,b.G=!0,b.X=!1,await b.K(),await b.Y.promise}catch(K){b.p7(),K instanceof Error&&(K.args=[{name:"WoLockManagerError",WA:K.name}],g.X(K))}})}}},wg=function(b){b.D&&b.J&&b.S&&b.visibility.isBackground()?b.V.qa(6E4):b.V.stop()},SuR=function(b){b.G&&(b.S=!0,wg(b))},n6H=function(b,R){b.G&&(b.J=R,wg(b))},E63=function(b,R){b.G&&(b.D=R,wg(b))},FL=function(b){b.offlineDeleteReason=b.offlineDeleteReason??
"OFFLINE_DELETE_REASON_UNKNOWN";
b.offlineModeType=b.offlineModeType??"OFFLINE_NOW";g.yp("offlineDeleteEvent",b)},ou=function(b,{videoId:R,
qm:h,offlineModeType:K}){b.encryptedVideoId=R;b.cotn=h?.cotn;b.offlineabilityFormatType=h?.maximumDownloadQuality;b.isRefresh=h?.isRefresh??!1;b.softErrorCount=h?.transferRetryCount??0;b.offlineModeType=K??"OFFLINE_NOW";(b.transferStatusType==="TRANSFER_STATUS_TYPE_UNKNOWN"&&b.statusType==="UNKNOWN_STATUS_TYPE"||!b.transferStatusType&&!b.statusType)&&g.kJ(Error("Woffle unknown transfer status"));g.yp("offlineTransferStatusChanged",b)},TPc=function(b,R,h,K){K={transferStatusType:"TRANSFER_STATUS_TYPE_PROCESSING",
statusType:"OFFLINING_STARTED",transferFirstStarted:!!K};R&&h&&(R=Math.floor(R/1024).toFixed(),h=Math.floor(h/1024).toFixed(),K.alreadyDownloadedKbytes=R,K.totalFetchedKbytes=R,K.totalContentKbytes=h);ou(K,b)},J93=function(b){ou({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_USER_PAUSE",
statusType:"SUSPENDED"},b)},kox=function(b){switch(b){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":return"OFFLINE_DATABASE_ERROR";
case "TRANSFER_FAILURE_REASON_PLAYABILITY":return"NOT_PLAYABLE";case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":return"TOO_MANY_RETRIES";case "TRANSFER_FAILURE_REASON_INTERNAL":return"OFFLINE_DOWNLOAD_CONTROLLER_ERROR";case "TRANSFER_FAILURE_REASON_STREAM_MISSING":return"STREAM_VERIFICATION_FAILED";case "TRANSFER_FAILURE_REASON_SERVER":case "TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING":return"OFFLINE_REQUEST_FAILURE";case "TRANSFER_FAILURE_REASON_NETWORK":return"OFFLINE_NETWORK_ERROR";default:return"UNKNOWN_FAILURE_REASON"}},
Df=function(b){return(b.actionMetadata?.retryScheduleIntervalsInSeconds?.length??0)>0},b0=function(b){return b.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD"&&!!b.entityKey},Rw=function(b){return b.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&!!b.entityKey},hG=function(b){return b.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&!!b.entityKey},YuH=function(b){return b.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE"&&!!b.entityKey},Kc=async function(b,R,h,K,I=!1){const N=
g.Su(b,R),p=g.Su(b,"downloadStatusEntity");
b=await Yx(h,{mode:"readonly",oT:!0},a=>g.cL.all([gg(a,N,R),gg(a,p,"downloadStatusEntity")]));
const l=b.length?b[0]:void 0;if(l){let a=b.length>1?b[1]:void 0;if(a){if(a.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&!I)return;a.downloadState=K}else a={key:p,downloadState:K};g.Zq(l,e$R,a);await Yx(h,{mode:"readwrite",oT:!0},v=>g.cL.all([EL(v,l,R),EL(v,a,"downloadStatusEntity")]))}},sZ=function(b,R){return b.actionType===R.actionType&&b.entityKey===R.entityKey},$V=function(b,R){if(b&&b.transferState!=="TRANSFER_STATE_COMPLETE"&&b.transferState!=="TRANSFER_STATE_FAILED"){const h=g.WJ(b.key).entityId;
ou({transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_BY_USER",statusType:"CANCELLED"},{videoId:h,qm:b,offlineModeType:R})}},Iw=function(b){if(!b||!b.thumbnails)return[];
const R=[];for(const h of b.thumbnails)h.url&&R.push(h.url);return R},NV=async function(b,R,h=[]){if(!h.length)return[];
R=await xx(b,R);b=new Set;for(var K of R)if(R=K.id||K.key)R=g.WJ(R).entityId,b.add(R);K=[];for(const I of h)h=I.offlineVideoData,h?.videoId&&!b.has(h.videoId)&&K.push(I);return K},pc=function(b,R,h){return new g.dh(b,{cotn:R,
raw_player_response:h,download_media:!0,start:Infinity,disable_watch_next:!0})},l0=function(){return{priority:1,
retryScheduleIntervalsInSeconds:[1,2,4]}},vU=function(b){if(!b.key)throw Error("Entity key is required.");
if(!b.actionProto)throw Error("OfflineOrchestrationAction is required.");const R=g.WJ(b.key),h=g.WJ(b.actionProto.entityKey);return new aw(h.entityType,R.entityId,b.actionProto,b.parentActionId,b.rootActionId,b.childActionIds,b.prereqActionId,b.postreqActionIds,b.retryScheduleIndex,b.hasChildActionFailed,Number(b.enqueueTimeSec)*1E3)},BU=function(b){return{key:g.Su(b.actionId,"offlineOrchestrationActionWrapperEntity"),
actionProto:b.action,parentActionId:b.parentActionId,rootActionId:b.rootActionId,childActionIds:b.childActionIds,prereqActionId:b.prereqActionId,postreqActionIds:b.postreqActionIds,retryScheduleIndex:b.retryScheduleIndex,hasChildActionFailed:b.hasChildActionFailed,enqueueTimeSec:(b.G/1E3).toFixed()}},QaR=async function(b,R,h){var K=g.Nh(),I=h.refreshData,N=h.isEnqueuedForExpiredStreamUrlRefetch,p=h.mj,l=h.offlineSourceData;
h=h.mediaCapabilities;b={entityKey:b};I&&(b.refreshData=I);N&&(b.isExpiredStreamUrlRefetch=N);p&&(b.downloadParameters=p);l&&(b.offlineSourceData=l);R={context:g.Ca(R),signatureTimestamp:20494,videos:[b]};h&&(R.mediaCapabilities=h);I=g.vI(O8n);try{var a=await g.bn(K,R,I,void 0,{lT:!0})}catch(v){if(v instanceof g.uN)throw a=`GetPDE network manager error: ${v.message}`,rg(a,v),Error(a);rg("GetPDE fetch request error",v);throw Error("GetPDE fetch request error");}K=a.errorMetadata?.status;if(a)K!==void 0&&
HU(K,"PDE");else throw rg("Network request failed for PDE"),Error("Network request failed for PDE");return a},xZz=async function(){const b=await M4();
return b?b.delete("yt-player-local-img"):!0},qV=async function(b){const R=await M4();
if(!R)throw Error("Cache API not supported");if(b.length){var h=await R.open("yt-player-local-img");await Promise.all(b.map(K=>h.delete(K)))}},dJ=async function(b){const R=await M4();
if(!R)throw Error("Cache API not supported");b.length&&await (await R.open("yt-player-local-img")).addAll(b)},fc=async function(b,R,h,K,I){const N=g.Su(b,"mainVideoEntity"),p=g.Su(b,"ytMainChannelEntity"),l=g.Su(b,"transfer"),a=g.Su(b,"videoDownloadContextEntity");
var v=await Yx(R,{mode:"readonly",oT:!0},Q=>g.cL.all([gg(Q,N,"mainVideoEntity"),gg(Q,p,"ytMainChannelEntity"),gg(Q,l,"transfer"),gg(Q,a,"videoDownloadContextEntity"),WV(Q,"ytMainChannelEntity"),WV(Q,"offlineOrchestrationActionWrapperEntity")]));
const [B,H,q,d,t,S]=v;if(B||H){v=B?Iw(B.thumbnail):[];var J=H?await mZ3(H,t):[];await qV(v.concat(J))}const e=[],Y=g.Su(b,"downloadStatusEntity");for(const Q of S)v=g.WJ(Q.key).entityId,J=vU(Q),J=g.WJ(J.action.entityKey).entityId,v!==b&&J!==b||sZ(h,Q.actionProto)||e.push(Q.key);await Yx(R,{mode:"readwrite",oT:!0},Q=>{const P=e.map($B=>J4(Q,$B));
P.push(J4(Q,N,{hm:!0}));P.push(J4(Q,Y,{hm:!0}));return g.cL.all(P)});
b=d?.offlineModeType;I&&(FL(I),I.offlineModeType&&(b=I.offlineModeType));$V(q,b);LN(K,{entityKey:N,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},y0=async function(b,R,h,K){const I=g.Su(b,"mainPlaylistEntity"),N=g.Su(b,"ytMainChannelEntity");
var p=await Yx(R,{mode:"readonly",oT:!0},Q=>g.cL.all([gg(Q,I,"mainPlaylistEntity"),gg(Q,N,"ytMainChannelEntity"),WV(Q,"mainPlaylistEntity"),WV(Q,"mainDownloadsListEntity"),WV(Q,"ytMainChannelEntity"),WV(Q,"offlineOrchestrationActionWrapperEntity")]));
const [l,a,v,B,H,q]=p;if(l||a){p=l?PqH(l):[];var d=a?await mZ3(a,H):[];await qV(p.concat(d))}p=[];d=new Map;if(l){p=await Z82(l,v,B);for(var t of p)d.set(t,{videoId:t,playlistId:b,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});t=await Yx(R,{mode:"readonly",oT:!0},$B=>g.cL.all([WV($B,"transfer"),WV($B,"videoDownloadContextEntity")]));
const [Q,P]=t;for(var S of Q)t=g.WJ(S.key).entityId,(t=d.get(t))&&S&&(t.cotn=S.cotn);for(var J of P)S=g.WJ(J.key).entityId,(S=d.get(S))&&J&&(S.offlineModeType=J.offlineModeType)}const e=[];for(const Q of q)J=g.WJ(Q.key).entityId,S=vU(Q),J!==b&&S.rootActionId!==b||sZ(h,Q.actionProto)||e.push(Q.key);const Y=g.Su(b,"mainPlaylistEntity");await Yx(R,{mode:"readwrite",oT:!0},Q=>{const P=e.map($B=>J4(Q,$B));
P.push(J4(Q,Y,{hm:!0}));return g.cL.all(P)});
if(l&&(p.reverse(),p))for(const Q of p)await fc(Q,R,h,K,d.get(Q))},tG=async function(b,R,h,K){const I=g.Su("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),N=new Map;
b=await Yx(b,{mode:"readwrite",oT:!0},p=>{const l=WV(p,"transfer"),a=WV(p,"offlineOrchestrationActionWrapperEntity"),v=WV(p,"videoDownloadContextEntity"),B=gg(p,I,"mainDownloadsListEntity");return g.cL.all([l,a,v,B]).then(([H,q,d,t])=>{const S=c9n.map(J=>kx(p,J));
for(const J of q)sZ(R,J.actionProto)||S.push(J4(p,J.key,{hm:!0}));t&&(t.downloads=[],S.push(EL(p,t,"mainDownloadsListEntity")));if(d)for(const J of d)q=g.WJ(J.key).entityId,q=g.Su(q,"transfer"),N.set(q,J.offlineModeType);return g.cL.all(S).then(()=>H)})});
for(const p of b){$V(p,N.get(p.key));b=g.WJ(p.key).entityId;const l={videoId:b,offlineDeleteReason:K,cotn:p.cotn,offlineModeType:N.get(p.key)};FL(l);b=g.Su(b,"mainVideoEntity");LN(h,{entityKey:b,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})}await xZz()},PqH=function(b,R){let h=[];
if(b.thumbnailStyleData)for(const K of b.thumbnailStyleData)h=h.concat(Iw(K?.value?.collageThumbnail?.coverThumbnail));b=Iw(R);return h.concat(b)},Z82=async function(b,R,h){const K=[],I=new Set;
if(h.length)for(var N of h)if(N.downloads?.length)for(const p of N.downloads)p.videoItem&&(h=g.WJ(p.videoItem).entityId,I.add(h));if(b.videos){for(const p of b.videos)N=JSON.parse(g.WJ(p).entityId),N.videoId&&!I.has(N.videoId)&&K.push(N.videoId);for(const p of R)if(p.key!==b.key&&(R=p.videos))for(const l of R)R=JSON.parse(g.WJ(l).entityId),R.videoId&&(R=K.indexOf(R.videoId),R!==-1&&K.splice(R,1))}return K},mZ3=async function(b,R){const h=Iw(b.avatar);
for(const K of R)if(K.id!==b.id)for(const I of Iw(K.avatar))R=h.indexOf(I),R!==-1&&h.splice(R,1);return h},uwn=async function(b){const R=g.Z(b.frameworkUpdates,jE);
b.frameworkUpdates&&R&&await Zf(R)},CqH=function(b){if(b.onResponseReceivedActions?.length&&(b=g.Z(g.Z(b.onResponseReceivedActions[0],XN3),VCz)?.actions,b?.length))return b},MC3=async function(b){if(!b)return[];
b=await Q2(b,AG,"mainDownloadsListEntity");return b?.downloads?.length?b.downloads.map(R=>R.videoItem??""):[]},i0=async function(b,R){const h=await r9U(b,R);
h&&await Yx(b,{mode:"readwrite",oT:!0},K=>{const I=[EL(K,h.mainDownloadsLibraryEntity,"mainDownloadsLibraryEntity")];h.mainDownloadsListEntity&&I.push(EL(K,h.mainDownloadsListEntity,"mainDownloadsListEntity"));return g.cL.all(I)})},r9U=async function(b,R){const h=g.Su("main_downloads_library_id","mainDownloadsLibraryEntity"),K=g.Su("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
b=await Yx(b,{mode:"readonly",oT:!0},a=>g.cL.all([gg(a,h,"mainDownloadsLibraryEntity"),gg(a,K,"mainDownloadsListEntity")]));
let [I,N]=b;b=I;let p=N;b||(b={id:h});for(const a of R)if(a===AG){if(b.smartDownloadsList)return;b.smartDownloadsList=a}else{var l=g.WJ(a).entityType;R={};l==="mainPlaylistEntity"?R.playlistItem=a:l==="mainVideoEntity"&&(R.videoItem=a);if(!g.RT(R)){if(p?.downloads){l=!1;for(const v of p.downloads)if(v.playlistItem===a||v.videoItem===a){l=!0;break}l||p.downloads.push(R)}else p={id:K,downloads:[R]};b.downloadsList=K}}return{mainDownloadsLibraryEntity:b,mainDownloadsListEntity:p}},zH=async function(b,
R){const h=g.Su("main_downloads_library_id","mainDownloadsLibraryEntity"),K=g.Su("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
var I=await Yx(b,{mode:"readonly",oT:!0},a=>g.cL.all([gg(a,h,"mainDownloadsLibraryEntity"),gg(a,K,"mainDownloadsListEntity"),gg(a,AG,"mainDownloadsListEntity")]));
const [N,p,l]=I;if(N){if(R===AG&&l?.downloads)l.downloads=[];else if(p?.downloads){I=g.WJ(R).entityType;for(let a=0;a<p.downloads.length;a++){const v=p.downloads[a];if(I==="mainVideoEntity"&&v.videoItem===R){p.downloads.splice(a,1);break}else if(I==="mainPlaylistEntity"&&v.playlistItem===R){p.downloads.splice(a,1);break}}}await Yx(b,{mode:"readwrite",oT:!0},a=>{const v=[EL(a,N,"mainDownloadsLibraryEntity")];p&&v.push(EL(a,p,"mainDownloadsListEntity"));l&&v.push(EL(a,l,"mainDownloadsListEntity"));
return g.cL.all(v)})}},UZ=async function(b,R){const h=g.Su(R,"transfer"),K=g.Su(R,"videoDownloadContextEntity");
b=await Yx(b,{mode:"readonly",oT:!0},p=>g.cL.all([gg(p,h,"transfer"),gg(p,K,"videoDownloadContextEntity")]));
const [I,N]=b;return{videoId:R,cotn:I?.cotn,offlineModeType:N?.offlineModeType}},GH=async function(b,R,h,K,I){const N=g.Su(b,"musicTrack"),p=g.Su(b,"transfer");
var l=await Yx(R,{mode:"readonly",oT:!0},t=>g.cL.all([gg(t,N,"musicTrack"),gg(t,p,"transfer"),WV(t,"musicTrack"),WV(t,"offlineOrchestrationActionWrapperEntity")]));
const [a,v,B,H]=l;a&&(l=await L$z(a,B),await qV(l));const q=[];for(const t of H){l=g.WJ(t.key).entityId;var d=vU(t);d=g.WJ(d.action.entityKey).entityId;l!==b&&d!==b||sZ(h,t.actionProto)||q.push(t.key)}await Yx(R,{mode:"readwrite",oT:!0},t=>{const S=q.map(J=>J4(t,J));
S.push(J4(t,N,{hm:!0}));return g.cL.all(S)});
$V(v);I&&FL(I);LN(K,{entityKey:N,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},gJ=async function(b,R,h,K,I){const N=g.Su(b,R),p=g.Su("music_downloads_library_id","musicDownloadsLibraryEntity");
var l=await Yx(h,{mode:"readonly",oT:!0},e=>g.cL.all([gg(e,N,R),gg(e,p,"musicDownloadsLibraryEntity"),WV(e,R),WV(e,"offlineOrchestrationActionWrapperEntity")]));
const [a,v,B,H]=l;a&&(l=await L$z(a,B),await qV(l));let q=[];l=new Map;if(a){q=await wNz(a,B,v);for(var d of q){const e=g.WJ(d).entityId;l.set(e,{videoId:e,playlistId:b,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"})}d=await xx(h,"transfer");for(var t of d)d=g.WJ(t.key).entityId,(d=l.get(d))&&t&&(d.cotn=t.cotn)}const S=[];for(const e of H)t=g.WJ(e.key).entityId,d=vU(e),t!==b&&d.rootActionId!==b||sZ(K,e.actionProto)||S.push(e.key);const J=g.Su(b,R);await Yx(h,{mode:"readwrite",oT:!0},
e=>{const Y=S.map(Q=>J4(e,Q));
Y.push(J4(e,J,{hm:!0}));return g.cL.all(Y)});
if(a&&(q.reverse(),q.length))for(const e of q)(b=g.WJ(e).entityId)&&await GH(b,h,K,I,l.get(b))},WU=async function(b,R,h){b=await Yx(b,{mode:"readwrite",
oT:!0},K=>{const I=WV(K,"transfer"),N=WV(K,"offlineOrchestrationActionWrapperEntity");return g.cL.all([I,N]).then(([p,l])=>{const a=F$R.map(v=>kx(K,v));
for(const v of l){l=g.WJ(v.actionProto.entityKey).entityType==="musicTrack";const B=v.actionProto.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD";sZ(R,v.actionProto)||l&&(!l||B)||a.push(J4(K,v.key,{hm:!0}))}return g.cL.all(a).then(()=>p)})});
for(const K of b)$V(K),b=g.WJ(K.key).entityId,FL({videoId:b,offlineDeleteReason:void 0,cotn:K.cotn}),b=g.Su(b,"musicTrack"),LN(h,{entityKey:b,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"});await xZz()},o6t=function(b){let R;
for(const h of b.additionalMetadatas)h.offlineMusicVideoData&&(R=h.offlineMusicVideoData);return{id:g.Su(b.videoId,"musicTrack"),videoId:b.videoId,title:b.title,thumbnailDetails:b.thumbnail,lengthMs:String(Number(b.lengthSeconds)*1E3),albumTitle:R?.releaseTitle,musicVideoType:R?.musicVideoType,contentRating:{explicitType:R?.explicitType},artistNames:R?.byline||R?.channelName,downloadMetadata:g.Su(b.videoId,"musicTrackDownloadMetadataEntity")}},wNz=async function(b,R,h){const K=[],I=new Set;
if(h?.downloadedTracks?.length)for(const N of h.downloadedTracks)I.add(N);if(b.tracks){for(const N of b.tracks)I.has(N)||K.push(N);for(const N of R)if(N.id!==b.id&&(R=N.tracks))for(const p of R)R=K.indexOf(p),R!==-1&&K.splice(R,1)}return K},L$z=async function(b,R){const h=Iw(b.thumbnailDetails);
for(const K of R)if(K.id!==b.id)for(const I of Iw(K.thumbnailDetails))R=h.indexOf(I),R!==-1&&h.splice(R,1);return h},SE=async function(b,R){var h=g.Su("music_downloads_library_id","musicDownloadsLibraryEntity");
let K=await Q2(b,h,"musicDownloadsLibraryEntity");K||(K={id:h});h=g.WJ(R).entityType;h==="musicTrack"?K.downloadedTracks?.includes(R)||(K.downloadedTracks=(K.downloadedTracks??[]).concat(R)):h==="musicPlaylist"?K.downloadedPlaylists?.includes(R)||(K.downloadedPlaylists=(K.downloadedPlaylists??[]).concat(R)):h!=="musicAlbumRelease"||K.downloadedAlbumReleases?.includes(R)||(K.downloadedAlbumReleases=(K.downloadedAlbumReleases??[]).concat(R));await e6(b,K,"musicDownloadsLibraryEntity")},nc=async function(b,
R){var h=g.Su("music_downloads_library_id","musicDownloadsLibraryEntity");
if(h=await Q2(b,h,"musicDownloadsLibraryEntity")){var K=g.WJ(R).entityType;let I;K==="musicTrack"?I=h.downloadedTracks:K==="musicPlaylist"&&(I=h.downloadedPlaylists);if(I?.length)for(K=0;K<I.length;K++)if(I[K]===R){I.splice(K,1);break}await e6(b,h,"musicDownloadsLibraryEntity")}},DZn=function(b){var R=b.videos;
b=[];const h=[];if(R)for(const I of R){var K=I.offlineVideoData.videoId;R=g.Su(K,"musicTrack");K=g.Su(K,"musicTrackDownloadMetadataEntity");b.push(R);h.push(K)}return{Bv:b,SO:h}},EZ=function(b,R,h){R={track:o6t(R)};
h&&(R.playlistId=h);if(b=g.Z(b.actionMetadata,bRt))R.maximumDownloadQuality=b.maximumDownloadQuality;return{musicTrackEntityActionMetadata:R}},hst=async function(b){var R=g.Nh();
b=H8x(b);const h=g.vI(RsR);try{var K=await g.bn(R,b,h,void 0,{lT:!0})}catch(I){if(I instanceof g.uN)throw K=`GetOffline network manager error: ${I.message}`,rg(K,I),Error(K);rg("GetOffline fetch request error",I);throw Error("GetOffline fetch request error");}R=K.errorMetadata?.status;if(!K)throw rg("Network request failed"),Error("Network request failed");if(R!==void 0)HU(R);else if(!K.videos||!K.videos.length)throw rg("No data"),Error("No data");return K.videos.map(I=>I.offlineVideoData)},TH=async function(b){var R=
g.Nh();
b=quz(b);const h=g.vI(RsR);try{var K=await g.bn(R,b,h,void 0,{lT:!0})}catch(I){if(I instanceof g.uN)throw K=`GetOffline network manager error for playlist: ${I.message}`,rg(K,I),Error(K);rg("GetOffline fetch request error for playlist",I);throw Error("GetOffline fetch request error for playlist");}R=K.errorMetadata?.status;if(!K)throw rg("Network request failed for playlist"),Error("Network request failed for playlist");if(R!==void 0)HU(R,"playlist");else if(!K.playlists||!K.playlists.length)throw rg("No data for playlist"),
Error("No data for playlist");return K.playlists.map(I=>I.offlinePlaylistData)},skt=async function(b,R,h,K){const I=await PV();
if(!I)return[];var N=[];K?.length?N=K:N=await xx(I,"mainPlaylistEntity");if(!N.length)return[];K=[];const p=Date.now()/1E3;for(const B of N){var l=B.downloadState?await Q2(I,B.downloadState,"mainPlaylistDownloadStateEntity"):void 0,a=(N=B?.entityMetadata)&&N.nextAutoRefreshIntervalSeconds?Number(N.nextAutoRefreshIntervalSeconds):NaN;a=Number.isNaN(a)?b:a;var v=l?.lastSyncedTimestampMillis?Number(l?.lastSyncedTimestampMillis)/1E3:0;l=l?.addedTimestampMillis?Number(l?.addedTimestampMillis)/1E3:0;if(h||
!N||v+a<=p){a=[];if(B.videos?.length)for(const H of B.videos)v=JSON.parse(g.WJ(H).entityId),v.videoId&&a.push(v.videoId);v="0";N&&(v=String(Number(N.offlineLastModifiedTimestampSeconds??0).toFixed()));K.push({playlistId:B.playlistId,videoIds:a,offlineLastModifiedTimestamp:v,autoSync:R,offlineDateAddedTimestamp:String(l.toFixed())})}}return K.length?await KQz(K):[]},$Px=async function(){var b=await PV();
if(!b)return!1;b=await xx(b,"refresh");if(!b[0]?.refreshTime)return!1;b=Number(b[0].refreshTime);const R=Date.now()/1E3;return isFinite(b)&&R>=b},NHn=async function(b,R){let h;
try{const K=await IZ3(b,R);await uwn(K);h=CqH(K)}catch(K){rg("getAndProcessSmartDownloadsResponse request or processing error",K)}return h},pvg=async function(b,R,h,K){const I=await PV();
if(!I)return[];var N=[];K?.length?N=K:N=await xx(I,"musicPlaylist");if(!N.length)return[];K=[];const p=Date.now()/1E3;for(const v of N){var l=(N=v?.entityMetadata)&&N.nextAutoRefreshIntervalSeconds?Number(N.nextAutoRefreshIntervalSeconds):NaN;const B=Number.isNaN(l)?b:l;let H=l=0;var a="DOWNLOAD_SYNC_STATE_UNKNOWN";v.downloadMetadata&&(a=await Q2(I,v.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),l=Number(a?.addedTimestampMillis??"0")/1E3,H=Number(a?.lastModifiedTimestampMillis??"0")/1E3,
a=a?.syncState??"DOWNLOAD_SYNC_STATE_UNKNOWN");if(h||a!=="DOWNLOAD_SYNC_STATE_UP_TO_DATE"||!N||Number(N.lastSyncedTimestampSeconds??0)+B<=p){N=[];if(v.tracks?.length)for(const q of v.tracks)N.push(g.WJ(q).entityId);K.push({playlistId:v.playlistId,videoIds:N,offlineLastModifiedTimestamp:String(H.toFixed()),autoSync:R,offlineDateAddedTimestamp:String(l.toFixed())})}}return K.length?await KQz(K):[]},IZ3=async function(b,R){var h=g.Nh(),K=await PV();
let I;K&&(I=await A9U(K));K=I;b={context:g.lM(),browseId:"FEdownloads",browseRequestSupportedMetadata:{downloadsBrowseParams:{offlineFeatureSettingState:{isSdEnabled:b},offlineClientState:K,clientStateRequestData:{preferredFormatType:R}}}};R=g.vI(lZ3);try{var N=await g.bn(h,b,R,void 0,{lT:!0})}catch(p){if(p instanceof g.uN)throw N=`DPS network manager error for smart downloads: ${p.message}`,rg(N,p),Error(N);rg("DPS fetch request error for smart downloads",p);throw Error("DPS fetch request error for smart downloads");
}h=N.errorMetadata?.status;if(N)h!==void 0&&HU(h,"smart downloads");else throw rg("Network request failed for smart downloads"),Error("Network request failed for smart downloads");return N},v02=async function(b,R){var h=g.Nh();
b={context:g.lM(),videoPlaybackPositionEntities:b,lastSyncTimestampUsec:R};R=g.vI(aZR);try{var K=await g.bn(h,b,R,void 0,{lT:!0})}catch(I){if(I instanceof g.uN)throw K=`VPPS network manager error: ${I.message}`,rg(K,I),Error(K);rg("VPPS fetch request error",I);throw Error("VPPS fetch request error");}h=K.errorMetadata?.status;if(K)h!==void 0&&HU(h,"position sync");else throw rg("Network request failed for position sync"),Error("Network request failed for position sync");return K},HU=function(b,R){R=
R?` for ${R}`:"";
if(b===0)throw b=`Empty response body${R}`,rg(b),Error(b);b=`Response with error${R}`;rg(b);throw Error(b);},KQz=async function(b){var R=g.Nh();
b=dZ2(b);const h=g.vI(BHH);try{var K=await g.bn(R,b,h,void 0,{lT:!0})}catch(I){if(I instanceof g.uN)throw K=`offlinePlaylistSyncCheck network manager error: ${I.message}`,rg(K,I),Error(K);rg("offlinePlaylistSyncCheck fetch request error",I);throw Error("offlinePlaylistSyncCheck fetch request error");}R=K.errorMetadata?.status;if(!K)throw rg("Network request failed for playlist sync"),Error("Network request failed for playlist sync");if(R!==void 0)HU(R,"playlist sync");else if(!K.offlinePlaylistSyncCheckDatas||
!K.offlinePlaylistSyncCheckDatas.length)throw rg("No data for playlist sync"),Error("No data for playlist sync");return K.offlinePlaylistSyncCheckDatas.map(I=>I.offlinePlaylistSyncCheckData)},HRx=async function(b,R){const h=new Map;
for(const K of R)h.set(K,await b.Y(K));return h},JG=function(b,R,h,K,I,N){R=g.Su(R,h);
return{actionType:b,entityKey:R,actionMetadata:{...N,priority:K,retryScheduleIntervalsInSeconds:I}}},fZ3=async function(b,R){var h=R.entityKey;
const K=g.Z(R.actionMetadata,kV)?.isEnqueuedForExpiredStreamUrlRefetch;try{let N=void 0;N=await q4x(b,R);let p;try{{const l=g.Z(R.actionMetadata,kV);var I=l?{maximumDownloadQuality:l.maximumDownloadQuality}:void 0}p=await QaR(h,b.QX,{isEnqueuedForExpiredStreamUrlRefetch:K,mj:I,offlineSourceData:N})}catch(l){const a=Df(R)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";rg("PDE handleAdd error");return YV(R,!1,void 0,
"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",a,"DOWNLOAD_STATE_FAILED")}await dPR(b,p,R);return YV(R,!0,p.orchestrationActions)}catch(N){return b="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",h="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",N instanceof g.QJ&&N.type==="QUOTA_EXCEEDED"&&(b="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",h="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),rg("PDE handleAdd error"),YV(R,!1,void 0,b,h,"DOWNLOAD_STATE_FAILED")}},
jkH=async function(b,R){const h=R.entityKey,K=g.WJ(h).entityId;
var I=await Yx(b.G,{mode:"readonly",oT:!0},H=>{const q=gg(H,h,"playbackData"),d=gg(H,g.Su(K,"offlineVideoPolicy"),"offlineVideoPolicy");H=gg(H,g.Su(K,"transfer"),"transfer");return g.cL.all([q,d,H])});
const [N,p,l]=I;if(!N||!p)return YV(R,!0);I=[];var a=N?.playerResponseJson?JSON.parse(N.playerResponseJson):null;if(l&&a){var v=yVr(b,a,l);I=await tZn(b,l)}I={lastPlayerResponseTimestampSeconds:N.playerResponseTimestamp,offlineToken:p.offlineToken,formatIds:I};a={};l?.maximumDownloadQuality&&(a.maximumDownloadQuality=l.maximumDownloadQuality);try{let H=void 0;H=await q4x(b,R);try{var B=await QaR(h,b.QX,{refreshData:I,mj:a,offlineSourceData:H,mediaCapabilities:v})}catch(q){const d=Df(R)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":
"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";rg("PDE handleRefresh error");return YV(R,!1,void 0,"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",d,"DOWNLOAD_STATE_FAILED")}await dPR(b,B,R);return YV(R,!0,B.orchestrationActions)}catch(H){return b="PDE handleRefresh error",H instanceof Error&&(b=`PDE handleRefresh error: ${H.message}`),v="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",B="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",H instanceof g.QJ&&H.type===
"QUOTA_EXCEEDED"&&(v="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",B="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),rg(b),YV(R,!1,void 0,v,B,"DOWNLOAD_STATE_FAILED")}},q4x=async function(b,R){R=g.WJ(R.entityKey).entityId;
R=g.Su(R,"videoDownloadContextEntity");b=await Q2(b.G,R,"videoDownloadContextEntity");return b?.offlineModeType?{offlineModeType:b.offlineModeType}:void 0},YV=function(b,R,h,K,I,N){return new eE(R?"OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS":"OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",Df(b),h,K,I,N)},dPR=async function(b,R,h){if(R.frameworkUpdates&&g.Z(R.frameworkUpdates,jE)){if(g.Z(R.frameworkUpdates,jE).mutations&&g.Z(R.frameworkUpdates,jE).mutations.length>0&&g.Z(R.frameworkUpdates,jE).mutations[0].type===
"ENTITY_MUTATION_TYPE_DELETE"){const K=g.WJ(g.Z(R.frameworkUpdates,jE).mutations[0].entityKey).entityId,I=await UZ(b.G,K),N=g.Z(h.actionMetadata,kV)?.playlistId;
N&&(I.playlistId=N);I.offlineDeleteReason="OFFLINE_DELETE_REASON_UNKNOWN";g.lv(b.QX)?await fc(K,b.G,h,b.X,I):g.LW(b.QX)&&await GH(K,b.G,h,b.X)}await Zf(g.Z(R.frameworkUpdates,jE))}},yVr=function(b,R,h){R=pc(b.QX,h.cotn,R);
h=g.tw(R);return g.bJH(R,h,b.QX)},tZn=async function(b,R){const h=[];
if(b=await Yx(b.G,{mode:"readonly",oT:!0},K=>{const I=[],N=R.offlineVideoStreams;if(N)for(const p of N)I.push(gg(K,p,"offlineVideoStreams"));return g.cL.all(I)}))for(const K of b)if(K?.streamsProgress){b=K.streamsProgress;
for(let I=0;I<b.length;I++){const N=JSON.parse(b[I].formatStreamBytes);h.push({itag:N.itag,lmt:N.lastModified,xtags:N.xtags})}}return h},AV3=async function(b,R){R=Df(R);
b=await xx(b.G,"videoPlaybackPositionEntity");if(b.length===0)return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",R);try{const h=await OZ.getInstance();if(!h)throw Error("prefStorage is undefined");const K=(await h.get("psi"))?.oa??"0",I=await v02(b,K),N={isPaused:I.watchHistoryPaused,oa:I.syncTimestampUsec};await h.set("psi",N);if(!N.isPaused){const p=g.Z(I.frameworkUpdates,jE);I.frameworkUpdates&&p&&await Zf(p)}}catch(h){return rg("PPE handleRefresh error: "+(h instanceof Error?h.message:
"unknown error")),new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",R,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",R)},zs2=async function(b,R){const h=Df(R),K=g.WJ(R.entityKey).entityId;
try{const I=await OZ.getInstance();if(!I)throw Error("prefStorage is undefined");const N=await I.get("psi"),p=g.Z(R.actionMetadata,iRp);if(N?.isPaused===!1&&p?.lastPlaybackPositionSeconds){const l={key:g.Su(K,"videoPlaybackPositionEntity"),videoId:K,lastPlaybackPositionSeconds:p.lastPlaybackPositionSeconds};await e6(b.G,l,"videoPlaybackPositionEntity")}}catch(I){return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
h)},UPp=async function(b,R){const h=Df(R);
try{const K=g.WJ(R.entityKey).entityId;if(K==="!*$_ALL_ENTITIES_!*$")await b83(b.G);else{const I=g.Su(K,"videoPlaybackPositionEntity");await OL(b.G,I)}}catch(K){return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,void 0,"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h)},Q0=async function(b){return BPU(b)},Gac=async function(b){return(await g.OMH(b)).filter(R=>!!R.url).map(R=>
R.url)},xV=function(b,R){var h=g.cG(R);
if(h===1||h===0)return Promise.resolve();(h=b.player?.getVideoData().videoId===R?b.player:null)&&h.stopVideo();b.X=0;return Q0(R)},mo=function(b,R,h=!1,K=!0){R=typeof R==="string"?R:R.videoDetails.videoId;
if(g.cG(R)===2){var I=b.player?.getVideoData().videoId===R?b.player:null;I&&I.stopVideo();g.uv(R,2);b.X=2;h?g0H(b.G):K&&WQ2(b.G)}},n0R=async function(b,R){const h=Df(R);
if(await Q2(b.G,R.entityKey,"transfer"))return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h);try{await S4n(b,R)}catch(K){return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h)},E0H=async function(b,R){const h=Df(R),K=await Q2(b.G,R.entityKey,"transfer");
if(!K||K.transferState!=="TRANSFER_STATE_COMPLETE")return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h);try{await S4n(b,R,!0)}catch(I){return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h)},TH2=async function(b,R){const h=Df(R),K=g.WJ(R.entityKey).entityId,I=await Yx(b.G,{mode:"readonly",
oT:!0},l=>{const a=gg(l,R.entityKey,"transfer");l=gg(l,g.Su(K,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.cL.all([a,l])}),[N,
p]=I;if(!N||N.transferState!=="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH")return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h);try{N.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE";await e6(b.G,N,"transfer");const l=g.WJ(N.key).entityId;ou({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_PLAYER_RESPONSE_REFRESH"},{videoId:l,qm:N,offlineModeType:p?.offlineModeType})}catch(l){return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h)},S4n=async function(b,R,h=!1){const K=g.Z(R.actionMetadata,JVt),I=g.WJ(R.entityKey).entityId,N=g.Su(I,"downloadStatusEntity");
var p=await Yx(b.G,{mode:"readonly",oT:!0},B=>{const H=gg(B,N,"downloadStatusEntity");B=gg(B,g.Su(I,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.cL.all([H,B])});
const [l,a]=p;p="TRANSFER_STATE_TRANSFER_IN_QUEUE";l?.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&(p="TRANSFER_STATE_PAUSED_BY_USER");const v={key:R.entityKey,transferState:p,cotn:g.yM(16),enqueuedTimestampMs:Date.now().toString(),maximumDownloadQuality:K?.maximumDownloadQuality,preferredAudioTrack:K?.preferredAudioTrack,transferRetryCount:0,isRefresh:h,hasLoggedFirstStarted:!1};await Yx(b.G,{mode:"readwrite",oT:!0},B=>{const H=[];h&&H.push(J4(B,g.Su(I,"offlineVideoStreams")));H.push(EL(B,v,"transfer"));
return g.cL.all(H)});
h&&await Q0(I);ou({transferStatusType:"TRANSFER_STATUS_TYPE_ENQUEUED",statusType:"ADDED_TO_QUEUE"},{videoId:I,qm:v,offlineModeType:a?.offlineModeType})},Y4n=function(b,R,h,K){if(!b.action.entityKey)throw Error("entityKey is missing.");
const {e2:I,entityId:N}=g.WJ(b.action.entityKey),p={entityType:I,entityId:N,offlineOrchestrationActionType:b.action.actionType,orchestrationAction:{orchestrationActionId:b.actionId}};R&&(p.offlineOrchestrationActionResult=R.status,p.isRetryable=h?!1:R.G,R.X&&(p.offlineOrchestrationFailureReason=ka3(R.X,p.isRetryable)));b.action.actionMetadata?.offlineLoggingData?.offlineModeType&&(p.offlineModeType=b.action.actionMetadata.offlineLoggingData.offlineModeType);K&&(p.additionalOrchestrationActions=K.map(l=>
({orchestrationActionId:l.actionId})));
return p},ka3=function(b,R){return b!=="OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR"||R?b==="OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"&&R?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":b:"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"},PU=function(b,R){const h={offlineOrchestrationContext:Y4n(b)};
R=tCH(R,h);ja2(y9r(),R,b.rootActionId)},Z1=function(b,R,h,K=[]){R={offlineOrchestrationContext:Y4n(b,R,h,K)};
R=tCH(3,R);ja2(y9r(),R,b.rootActionId)},esz=function(b,R){for(const h of R)PU(h,1),b.actions.push(h);
b.actions.sort(b.G)},ORc=function(b,R){if(R)for(let h=0;h<b.actions.length;h++)if(R==="!*$_ALL_ENTITIES_!*$"&&b.actions[h].actionId!==R||R!=="!*$_ALL_ENTITIES_!*$"&&b.actions[h].rootActionId===R&&b.actions[h].actionId!==R)b.actions.splice(h,1),h--},Qk3=function(b,R){for(const h of b.actions)if(h.actionId===R)return!0;
return!1},ZRR=async function(b,R,h,K,I){b=new xPz(b,R,h,K,I);
await mPz(b);PAn(b);return b},mPz=async function(b){const R=await xx(b.Y,"offlineOrchestrationActionWrapperEntity");
await cU(b,R)},PAn=function(b){const R=b.G.actions[0];
return b.V?(R?.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&b.V[0].action.actionType!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(b.S=!0),Promise.resolve()):cVx(b)},cVx=async function(b){if(b.V)throw Error("Already processing an action");
if(!b.HY()){var R=b.G.actions.shift();n6H(b.G6,!R);if(R!==void 0){R.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&R.actionId==="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS"&&ORc(b.G,R.actionId);var h="";R.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&R.rootActionId===R.actionId&&(h=R.actionId);var K=[R];b.V=K;if(R=b.nR[R.entityType]){for(const I of K)PU(I,2);try{const I=await HRx(R,K.map(N=>N.action));
for(const N of K){const p=I.get(N.action);await uUg(b,N,p)}ORc(b.G,h)}catch(I){rg("Orchestration error",I);try{await Xvn(b,K)}catch(N){rg("Orchestration retry error",N);for(const p of K)p.retryScheduleIndex<3&&esz(b.G,[p])}}finally{b.V=void 0}}else b.V=void 0;await cVx(b)}}},uUg=async function(b,R,h){var K=R.retryScheduleIndex+2===3;
if(h.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS"){var I=void 0;try{I=h.V?.map(N=>b.createAction(N,R))}catch(N){Z1(R,h,K);
LN(b.D,{entityKey:R.action.entityKey,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_UNSUPPORTED_ENTITY_FAILED"});rg("Orchestration subactions creation error",N);return}Z1(R,h,K,I);if(I){const N=I.map(l=>BU(l));
let p=0;for(;p<I.length&&!b.S;)await Yx(b.Y,{mode:"readwrite",oT:!0},l=>{const a=[];a.push(TA(l,N.slice(p,p+10),"offlineOrchestrationActionWrapperEntity"));return g.cL.all(a)}),p+=10;
if(b.S){b.S=!1;return}}h=BU(R);await OL(b.Y,h.key);PU(R,4)}else if(h.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE")if(Z1(R,h,K),h.G&&R.retryScheduleIndex+1<3)await Xvn(b,[R]);else{K={entityKey:R.action.entityKey,failureReason:h?.Y?h.Y:"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN"};I=void 0;g.lv(b.QX)?I="mainVideoDownloadStateEntity":g.LW(b.QX)&&(I="musicTrackDownloadMetadataEntity");if(I&&h.downloadState){const N=g.WJ(R.action.entityKey).entityId;await Kc(N,I,b.Y,h.downloadState)}LN(b.D,K);
h.downloadState==="DOWNLOAD_STATE_FAILED"&&b.QX.N("html5_auto_retry_failed_pde_actions")||(rg("Orchestration result is not retryable, deleting action"),await OL(b.Y,BU(R).key))}},Xvn=async function(b,R){for(const h of R){const K=h.action?.actionMetadata?.retryScheduleIntervalsInSeconds||[1,
2,4];let I=1;h.retryScheduleIndex<K.length&&(I=K[h.retryScheduleIndex]);h.G=I*1E3+Date.now();h.retryScheduleIndex++}await VZ3(b,R)},CA3=async function(b,R){return(await xx(b.Y,"offlineOrchestrationActionWrapperEntity",R)).filter(Iz3)},cU=async function(b,R){let h=[];
var K=Infinity;let I=4E3;for(const p of R){R=Number(p.enqueueTimeSec);const l=MZ2(R);var N=p.retryScheduleIndex;N=N!=null&&N>0;l>0&&N?(K=Math.min(K,R),I=Math.min(l,I)):h.push(p)}isFinite(K)&&(!b.X.isActive()||K<b.K)&&(b.K=K,b.X.start(I));b.J.kV()||(K=h.length,h=h.filter(p=>!rVt.includes(p.actionProto?.actionType||"OFFLINE_ORCHESTRATION_ACTION_TYPE_UNKNOWN")),K=h.length<K,!b.X.isActive()&&K&&b.X.start(1));
h.length>0&&LQz(b,h);await PAn(b)},MZ2=function(b){b=b*1E3-Date.now();
return b>4E3?4E3:b},LQz=function(b,R){R.length!==0&&R.forEach(h=>{h=vU(h);
h.retryScheduleIndex<3&&esz(b.G,[h])})},wvH=async function(b){var R=await CA3(b);
const h=[];for(const K of R)R=g.WJ(K.key).entityId,Qk3(b.G,R)||h.push(K);await cU(b,h)},VZ3=function(b,R){if(R.length===0)return Promise.resolve([]);
R=R.map(h=>BU(h));
return DKz(b.Y,R)},FQ3=async function(b,R){const h=R.videoId;
let K=!0;if(R.captionTracks.length){const I=edU(R);b.G=new g.zv(b.qJ,R,I)}else if(R.Zl)b.G=new g.UX(b.qJ,R.Zl,h,g.obT(R),R.yu,R.eventId),K=R.yu;else return;return new Promise(I=>{b.G?.S({fN:async()=>{await b.fN(h,K);I()},
T9:()=>{}})})},o03=async function(b){b=await v6U(b);
return!!b&&b.length>0},DP2=async function(b,R){if(R.length===0)return[];
const h=R.map(I=>g.Su(I,"transfer")),K=(await xx(b.G,"transfer",h)).filter(Iz3).map(I=>g.WJ(I.key).entityId);
b=R.filter(I=>K.indexOf(I)===-1);
if(b.length===0)return[];for(const I of b)await Q0(I);return b},h1R=async function(b,R,h,K,I,N){let p="STREAM_TYPE_UNKNOWN";
h.video&&h.audio?(p="STREAM_TYPE_AUDIO_AND_VIDEO",rg("unexpected stream type")):h.video&&!h.audio?p="STREAM_TYPE_VIDEO":!h.video&&h.audio&&(p="STREAM_TYPE_AUDIO");const l=g.Su(R,"offlineVideoStreams"),a={numBytesDownloaded:I.toFixed(),numTotalBytes:N.toFixed(),streamType:p,streamState:"DOWNLOAD_STREAM_STATE_IN_PROGRESS",formatStreamBytes:JSON.stringify(K),itag:p==="STREAM_TYPE_AUDIO_AND_VIDEO"?Number(h.itag):void 0};await Yx(b,{mode:"readwrite",oT:!0},v=>{const B=gg(v,l,"offlineVideoStreams"),H=gg(v,
g.Su(R,"transfer"),"transfer");return g.cL.all([B,H]).then(([q,d])=>{if(!d)return J4(v,l).then(()=>{});
var t=bqc(q);q=R1p(q,K,a,l);const S=EL(v,q,"offlineVideoStreams");bqc(q)>t&&(d.lastProgressTimeMs=Date.now().toString());t=[S];d.offlineVideoStreams||(d.offlineVideoStreams=[]);d.offlineVideoStreams.indexOf(l)===-1&&(d.offlineVideoStreams.push(l),t.push(EL(v,d,"transfer")));return g.cL.all(t)})})},KKr=async function(b,R){R=g.Su(R,"offlineVideoStreams");
if((R=await Q2(b,R,"offlineVideoStreams"))&&R.streamsProgress){for(const h of R.streamsProgress)h.streamState="DOWNLOAD_STREAM_STATE_COMPLETE",h.numTotalBytes!==h.numBytesDownloaded&&(h.numBytesDownloaded=h.numTotalBytes);await e6(b,R,"offlineVideoStreams")}},R1p=function(b,R,h,K){if(b&&b.streamsProgress){K=b;
a:{R=`${R.itag};${R.xtags}`;var I=b.streamsProgress;for(let N=0;N<I.length;N++){const p=JSON.parse(I[N].formatStreamBytes);if(`${p.itag};${p.xtags}`===R){I[N]=h;h=I;break a}}I.push(h);h=I}K.streamsProgress=h}else b={key:K,streamsProgress:[h]};return b},bqc=function(b){if(b?.streamsProgress){let R=0;
b=b.streamsProgress;for(let h=0;h<b.length;h++){const K=b[h];isNaN(Number(K.numBytesDownloaded))?rg("stream progress bytes number invalid"):R+=Number(K.numBytesDownloaded)}return R}return 0},g0H=async function(b){if(b.G){const R=b.G;
b.V.stop();await u0(b,"TRANSFER_STATE_PAUSED_BY_USER");const h=R?.key?g.WJ(R.key).entityId:"";h&&b.X&&await Kc(h,b.X,b.Y,"DOWNLOAD_STATE_PAUSED");const K=await X9(b,h);J93({videoId:h,qm:R,offlineModeType:K})}else V0(b,"onTransferPausedByUser");Cc(b);MV(b)},WQ2=async function(b){if(b.G){b.V.stop();
await u0(b,"TRANSFER_STATE_TRANSFER_IN_QUEUE");var R=b.G;(R=R?.key?g.WJ(R.key).entityId:"")&&b.X&&await Kc(R,b.X,b.Y,"DOWNLOAD_STATE_PAUSED");Cc(b)}else V0(b,"onTransferPausedByNetwork")},rJ=async function(b){if(b.G){b.V.start(108E5);
await u0(b,"TRANSFER_STATE_TRANSFERRING");var R=b.G;(R=R?.key?g.WJ(R.key).entityId:"")&&b.X&&await Kc(R,b.X,b.Y,"DOWNLOAD_STATE_DOWNLOAD_IN_PROGRESS")}else V0(b,"onTransferStart")},sHH=async function(b,R,h){if(b.G){b.G.transferState!=="TRANSFER_STATE_TRANSFERRING"&&await rJ(b);
var K=Date.now();K-b.MJ>1E3&&(b.MJ=K,await h1R(b.Y,h.videoId,h.Y,h.Of,h.bytesDownloaded,h.G),!b.U||b.U&&K-b.G6>b.Zr)&&(b.G6=K,K=await X9(b,R),TPc({videoId:R,qm:b.G,offlineModeType:K},h.bytesDownloaded,h.G));b.V.start(108E5)}else V0(b,`onTransferProgress: ${R}`)},IVt=async function(b){if(b.G){var R=b.G;
b.V.stop();if(R&&b.S){var h=pc(b.api.L(),R.cotn,b.S);await $uH(b,h)}await u0(b,"TRANSFER_STATE_COMPLETE","DOWNLOAD_STREAM_STATE_COMPLETE");(h=R?.key?g.WJ(R.key).entityId:"")&&b.X&&await Kc(h,b.X,b.Y,"DOWNLOAD_STATE_COMPLETE");await KKr(b.Y,h);var K=await X9(b,h);ou({transferStatusType:"TRANSFER_STATUS_TYPE_COMPLETED",statusType:"SUCCESS"},{videoId:h,qm:R,offlineModeType:K});Cc(b);MV(b)}else V0(b,"onTransferComplete")},NWH=async function(b){await lz3();
b=b.T6;var R=g.ZL();R=Object.keys(R);await DP2(b,R)},aVn=async function(b){b=(await xx(b.Y,"transfer")).filter(pDz).sort(lVt);
return b.length===0?void 0:b[0]},HqH=async function(b,R){if(!b.K){b.K=!0;
b.G=R;var h=g.WJ(b.G.key).entityId;if(b.G.transferState==="TRANSFER_STATE_TRANSFERRING"){var K=await X9(b,h);ou({transferStatusType:"TRANSFER_STATUS_TYPE_RESUME_PROCESSING",statusType:"OFFLINING_RETRIED"},{videoId:h,qm:b.G,offlineModeType:K})}else b.G.transferState!=="TRANSFER_STATE_TRANSFER_IN_QUEUE"||b.G.transferRetryCount||b.G.hasLoggedFirstStarted||(K=await X9(b,h),b.G.hasLoggedFirstStarted=!0,await vqr(b),TPc({videoId:h,qm:b.G,offlineModeType:K},void 0,void 0,!0));await rJ(b);h=null;try{h=await BWz(b,
R),b.S=h}catch(I){rg("error getting player response",I,R.cotn);await b.H9("TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING");return}K=pc(b.api.L(),R.cotn,h);await $uH(b,K);K.s7=await Gac(K.videoId);h=b.D;R=R.maximumDownloadQuality;K.getPlayerResponse();g.uv(K.videoId,2);h.X=2;h.Y=!1;h.player?.dispose();h.player=h.api.aX(K);h.player.vZ({localmediachange:h.JB,signatureexpired:h.SE,statechange:h.V},h);h.N("html5_generate_content_po_token")&&h.player.MH();R=h.YB(R);h.player.zl(g.I8(R,R,!0,"m"),!1);h.player.J1(!1);
b.V.start(108E5)}},Cc=function(b){b.G=void 0;
b.S=void 0;b.V.stop()},MV=async function(b,R=!1){if(b.G)throw Error("Already downloading a video");
b.G6=0;b.K=!1;const h=await aVn(b);E63(b.JX,!h);h&&b.J.kV()?(R&&await new Promise(K=>{g.QB(K,1E3)}),await HqH(b,h)):!h&&b.G&&Cc(b)},X9=async function(b,R){return(await Q2(b.Y,g.Su(R,"videoDownloadContextEntity"),"videoDownloadContextEntity"))?.offlineModeType??void 0},qdn=async function(b){b.S&&(await xV(b.D,b.S.videoDetails.videoId),Cc(b))},$uH=async function(b,R){try{(R.captionTracks.length||R.Zl)&&!await o03(R.videoId)&&await FQ3(b.pR,R)}catch(h){rg("Caption downloading error",h,R.cotn)}},vqr=
async function(b,R){if(b.G){var h=b.G;
await Yx(b.Y,{mode:"readwrite",oT:!0},K=>{const I=[EL(K,h,"transfer")];R&&I.push(R(K));return g.cL.all(I)})}},BWz=async function(b,R){R=g.WJ(R.key).entityId;
R=g.Su(R,"playbackData");b=await Q2(b.Y,R,"playbackData");if(b?.playerResponseJson)return JSON.parse(b.playerResponseJson);throw Error("No PlayerResponse found");},u0=async function(b,R,h,K){if(b.G){b.G.transferState=R;
b.G.failureReason=K;try{await vqr(b,I=>h?WV(I,"offlineVideoStreams",b.G.offlineVideoStreams).then(N=>{for(const p of N)if(p&&p.streamsProgress)for(const l of p.streamsProgress)l.streamState=h;return TA(I,N.filter(p=>!!p),"offlineVideoStreams")}):g.cL.resolve(void 0))}catch(I){I instanceof g.QJ&&I.type==="QUOTA_EXCEEDED"&&await b.H9("TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE")}}else V0(b,`saveTransferState: ${R}`)},V0=function(b,R){b.api.YZ("woffle",{mcte:R});
rg("missing current transfer entity.")},duR=function(b){const R=(b.G.transferRetryCount||0)<3;
R&&(b=b.G,b.transferRetryCount=(b.transferRetryCount||0)+1);return R},fVn=async function(b,R="TRANSFER_FAILURE_REASON_UNKNOWN"){b.G||V0(b,`setTransferToFailed: ${R}`);
var h="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";R==="TRANSFER_FAILURE_REASON_NETWORK"?h="OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED":R==="TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE"&&(h="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED");await u0(b,"TRANSFER_STATE_FAILED","DOWNLOAD_STREAM_STATE_ERROR_STREAMS_MISSING",R);LN(b.C,{entityKey:b.G?.key,failureReason:h});h=b.G?g.WJ(b.G.key).entityId:"";const K=await X9(b,h);b={videoId:h,qm:b.G,offlineModeType:K};h={transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_WITH_FAILURE",
statusType:"FAILED"};R&&(h.transferFailureReason=R,h.failureReason=kox(R));ou(h,b)},pDz=function(b){return Lc[b.transferState]!==void 0},lVt=function(b,R){const h=Lc[b.transferState],K=Lc[R.transferState];
return h!==K?h-K:Number(b.enqueuedTimestampMs)-Number(R.enqueuedTimestampMs)},ye3=async function(b){g.rw(b.api,"onOrchestrationBecameLeader");
await b.Xw()},Aer=async function(b){const R=await PV();
if(R){b.Y=new tY3(R,b.api,b.X,b.G);var h=b.J(R);b.K=await ZRR(R,h,b.X,b.G,b.QX);await jH3(b)}else rg("PES is undefined")},jH3=async function(b){if(b.Y){b.Y.G||await MV(b.Y);
b.QX.N("woffle_enable_main_downloads_library")&&await b.gp();b.QX.N("html5_offline_playback_position_sync")&&(await b.MJ(),await b.Sy(864E5));await b.refreshAllStaleEntities(43200,!0);await b.U();b.QX.N("html5_retry_downloads_for_expiration")&&await b.He();b.G6=g.x_(()=>{b.refreshAllStaleEntities(43200,!0);b.U()},9E5);
g.z6(g.G6(),()=>b.o7());
var R=await PV();await g6c(R);SuR(b.X)}else rg("transferManager is undefined")},iqr=async function(){const b=await PV();
if(!b)return[];const R=Date.now()/1E3,h=await xx(b,"offlineVideoPolicy");for(const K of h)K.expirationTimestamp&&Number(K.expirationTimestamp)<R&&(K.action="OFFLINE_VIDEO_POLICY_ACTION_DISABLE",K.offlinePlaybackDisabledReason="OFFLINE_PLAYBACK_DISABLED_REASON_CLIENT_OFFLINE_CONTENT_EXPIRED",await e6(b,K,"offlineVideoPolicy"));return h.map(K=>K.key)},wJ=async function(b,R,h,K,I){var N=await PV();
if(!N)return[];R=R.map(p=>{var l=g.Su(p,h);l={actionType:K,entityKey:l,actionMetadata:{...l0(),...I}};K!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&(l.actionMetadata.priority=0);p=new aw(h,p,l);return BU(p)});
N=DKz(N,R);W$z(b.X);return N},z1r=async function(b,R,h,K){const I=[];
for(const N of R)if(!N.upToDate&&(!h||N.shouldAutoSyncMetadata)&&N.playlistId){R={};switch(K){case "mainPlaylistEntity":R={mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:N.checkInSeconds,autoSync:h}};break;case "musicPlaylist":R={musicPlaylistEntityActionMetadata:{autoSync:h}}}(R=await wJ(b,[N.playlistId],K,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",R))&&I.push(...R)}return I},UuH=async function(b,R){if(R.length){const h=l0();
g.Zq(h,kV,{isEnqueuedForExpiredStreamUrlRefetch:!0});b.api.YZ("qrd",{v:R.length});return wJ(b,R,"playbackData","OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",h)}return[]},gqp=async function(b,R){const h=Df(R);
var K=g.WJ(R.entityKey).entityId;let I=[];try{I=await Gdp(b,K),b.QX.N("woffle_enable_main_downloads_library")&&I?.length&&await i0(b.G,[R.entityKey])}catch(p){return R="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",K="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",p instanceof g.QJ&&p.type==="QUOTA_EXCEEDED"?(R="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",K="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"):rg("Playlist add error"),new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
h,void 0,R,K)}const N=[];b.QX.N("html5_offline_prevent_redownload_downloaded_video")&&(I=await NV(b.G,"mainVideoEntity",I));if(I?.length)for(const p of I)b=p.offlineVideoData,b?.videoId&&N.push(JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",b.videoId,"mainVideoEntity",Number(R.actionMetadata?.priority||0)+1,F9,ow(R,b,K)));return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h,N)},Sdx=async function(b,R){const h=Df(R);
var K=R.entityKey,I=g.WJ(K).entityId,N=[],p=!1;I==="!*$_ALL_ENTITIES_!*$"?(p=!0,N=await xx(b.G,"mainPlaylistEntity")):(K=await Q2(b.G,K,"mainPlaylistEntity"))&&N.push(K);if(!N?.length)return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h);var l=g.Z(R.actionMetadata,WKt);K=l?.nextAutoRefreshIntervalSeconds;const a=l?.autoSync;let v=[],B=!0;l=!0;let H=!1;if(p||a!==!1){try{v=await skt(0,!!a,!0,N)}catch(S){S instanceof Error&&S.message==="No data"?I==="!*$_ALL_ENTITIES_!*$"?await tG(b.G,R,b.X,
"OFFLINE_DELETE_REASON_UNAVAILABLE"):await y0(I,b.G,R,b.X):S instanceof Error&&S.message==="Empty response body"&&rg(S.message)}if(!v.length||!p&&v[0].playlistId!==I)return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h)}if(p){R=[];for(var q of v)q.upToDate||a&&!q.shouldAutoSyncMetadata||!q.playlistId||R.push(JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",q.playlistId,"mainPlaylistEntity",0,F9,{mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:q.checkInSeconds,autoSync:a}}));
return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h,R)}v.length&&(q=v[0],H=!!q.upToDate,a&&(B=q.shouldAutoSyncMetadata??!0,l=q.shouldAutoSyncVideos??!0,q.checkInSeconds&&(K=q.checkInSeconds)));if(H||!B)return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h);q=[];N=N[0];p=N.downloadState?await Q2(b.G,N.downloadState,"mainPlaylistDownloadStateEntity"):void 0;p=p?.addedTimestampMillis?String(p.addedTimestampMillis):void 0;try{q=await Gdp(b,I,p,K)}catch(S){if(S instanceof Error&&S.message===
"No data for playlist")await y0(I,b.G,R,b.X);else if(S instanceof Error&&S.message==="Empty response body for playlist")rg(S.message);else return R="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",I="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",S instanceof g.QJ&&S.type==="QUOTA_EXCEEDED"&&(R="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",I="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,void 0,R,I)}if(!l)return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
h);b=[];K=new Map;if(q?.length)for(var d of q)l=d.offlineVideoData,l?.videoId&&K.set(l.videoId,l);d=new Map;l=[];if(N?.videos?.length)for(var t of N.videos)if(N=JSON.parse(g.WJ(t).entityId).videoId)K.has(N)?(d.set(N,K.get(N)),K.delete(N)):l.push(N);t=Number(R.actionMetadata?.priority||0)+1;for(const [S,J]of K.entries())b.push(JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",S,"mainVideoEntity",t,F9,ow(R,J,I)));for(const [S,J]of d.entries())b.push(JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",S,"mainVideoEntity",
t,F9,ow(R,J,I)));for(const S of l)b.push(JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",S,"mainVideoEntity",0,F9,{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"},mainVideoEntityActionMetadata:{playlistId:I}}));return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h,b)},nqn=async function(b,R){const h=Df(R);
try{const K=g.WJ(R.entityKey).entityId;K==="!*$_ALL_ENTITIES_!*$"?await tG(b.G,R,b.X,R.actionMetadata?.offlineLoggingData?.offlineDeleteReason):(await y0(K,b.G,R,b.X),b.QX.N("woffle_enable_main_downloads_library")&&await zH(b.G,R.entityKey))}catch(K){return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
h)},Gdp=async function(b,R,h,K){R=await TH([R]);
const {mainPlaylistEntity:I,tV:N}=await EqH(b,R[0],h,K);b=PqH(I,N?.avatar);try{await dJ(b)}catch(p){p instanceof Error&&p.message==="Failed to fetch"&&rg(p.message)}return R[0].videos},ow=function(b,R,h){R={offlineVideoData:R,
playlistId:h};if(b=g.Z(b.actionMetadata,WKt))R.maximumDownloadQuality=b.maximumDownloadQuality;return{mainVideoEntityActionMetadata:R}},EqH=async function(b,R,h,K){const I=Date.now().toString();
h||(h=I);var N=R.videos;const p=R.playlistId,l=[],a=[];if(N)for(const q of N){N=q.offlineVideoData;if(!N||!N.videoId)throw rg("Invalid offlineVideoData for playlist"),Error("Invalid offlineVideoData for playlist");N=N.videoId;N={id:g.Su(JSON.stringify({videoId:N,playlistId:p}),"mainPlaylistVideoEntity"),video:g.Su(N,"mainVideoEntity")};l.push(N);a.push(N.id)}let v;const B={key:g.Su(p,"mainPlaylistDownloadStateEntity"),addedTimestampMillis:h,lastSyncedTimestampMillis:I},H={key:g.Su(p,"mainPlaylistEntity"),
playlistId:p,videos:a,title:R.title,thumbnailStyleData:TWz(R),visibility:Je2(R),downloadState:B.key};R.channel&&(h=R.channel.offlineChannelData,v=kdc(g.Su(p,"ytMainChannelEntity"),h),H.channelOwner=v.id);H?.entityMetadata?(H.entityMetadata.offlineLastModifiedTimestampSeconds=R.lastModifiedTimestamp,K&&(H.entityMetadata.nextAutoRefreshIntervalSeconds=String(K))):H&&(H.entityMetadata={nextAutoRefreshIntervalSeconds:K?String(K):void 0,offlineLastModifiedTimestampSeconds:R.lastModifiedTimestamp});try{await Yx(b.G,
{mode:"readwrite",oT:!0},q=>{var d=EL(q,H,"mainPlaylistEntity");const t=EL(q,B,"mainPlaylistDownloadStateEntity");d=[d,t];for(const S of l)d.push(EL(q,S,"mainPlaylistVideoEntity"));v&&d.push(EL(q,v,"ytMainChannelEntity"));return g.cL.all(d)})}catch(q){throw rg("PES failure for playlist"),Error("PES failure for playlist");
}return{mainPlaylistEntity:H,tV:v,oVZ:l}},TWz=function(b){const R=[];
var h=b.videos;h&&h.length>0&&R.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_FIRST_VIDEO"),value:{collageThumbnail:{coverThumbnail:h[0].offlineVideoData.thumbnail}}});if((b=b.additionalMetadadatas)&&b.length>0)for(const K of b)switch(b=K.offlineBundleItemPlaylistData,h={collageThumbnail:{coverThumbnail:b?.coverThumbnail}},b?.style){case "BUNDLE_ITEM_STYLE_UNSPECIFIED":R.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_UNKNOWN"),value:h});break;case "BUNDLE_ITEM_STYLE_TWO_BY_TWO":R.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_TWO_BY_TWO"),
value:h});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO_AVATAR":R.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO_AVATAR"),value:h});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO":R.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO"),value:h})}return R},Je2=function(b){switch(b.privacy){case "PRIVATE":return"PLAYLIST_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_VISIBILITY_UNLISTED";default:return"PLAYLIST_VISIBILITY_UNKNOWN"}},kdc=function(b,R){return{id:b,
channelId:R.channelId,title:R.title,avatar:R.thumbnail}},OqR=async function(b,R){const h=Df(R);
var K=g.WJ(R.entityKey).entityId;const I=g.Z(R.actionMetadata,D1),N=!I?.playlistId;try{await Ydt(b,K,void 0,I?.offlineVideoData,N)}catch(p){return K="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",R="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",p instanceof g.QJ&&p.type==="QUOTA_EXCEEDED"&&(K="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",R="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,void 0,K,R)}b=Number(R.actionMetadata?.priority||
0)+1;R=(R=g.Z(R.actionMetadata,D1))?{playbackDataActionMetadata:{maximumDownloadQuality:R.maximumDownloadQuality}}:void 0;K=JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",K,"playbackData",b,e1n,R);return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h,[K])},QHH=async function(b,R){const h=Df(R),K=g.WJ(R.entityKey).entityId;
var I=await Q2(b.G,R.entityKey,"mainVideoEntity"),N=I?await Q2(b.G,I.downloadState,"mainVideoDownloadStateEntity"):void 0;if(!I||!N)return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h);let p;try{await Ydt(b,K,N.addedTimestampMillis,g.Z(R.actionMetadata,D1)?.offlineVideoData),I=1,I=Number(R.actionMetadata?.priority||0)+1,p=JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",K,"playbackData",I,e1n)}catch(l){if(l instanceof Error&&l.message==="No data"){I=await UZ(b.G,K);if(N=g.Z(R.actionMetadata,
D1)?.playlistId)I.playlistId=N;I.offlineDeleteReason="OFFLINE_DELETE_REASON_UNAVAILABLE";await fc(K,b.G,R,b.X,I)}else if(l instanceof Error&&l.message==="Empty response body")rg(l.message);else return b="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",R="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",l instanceof g.QJ&&l.type==="QUOTA_EXCEEDED"&&(b="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",R="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
h,void 0,b,R)}return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h,p?[p]:void 0)},xug=async function(b,R){const h=Df(R);
try{const K=g.WJ(R.entityKey).entityId;if(K==="!*$_ALL_ENTITIES_!*$")await tG(b.G,R,b.X,R.actionMetadata?.offlineLoggingData?.offlineDeleteReason);else{const I=await UZ(b.G,K),N=g.Z(R.actionMetadata,D1)?.playlistId;N&&(I.playlistId=N);I.offlineDeleteReason=R.actionMetadata?.offlineLoggingData?.offlineDeleteReason;await fc(K,b.G,R,b.X,I);b.QX.N("woffle_enable_main_downloads_library")&&await zH(b.G,R.entityKey)}}catch(K){return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h)},Ydt=async function(b,R,h,K,I){K||(K=(await hst([R]))[0]);
const {mainVideoEntity:N,channelEntity:p}=await mun(b,K,h,I);try{const l=Iw(N.thumbnail),a=Iw(p.avatar);await dJ(l.concat(a))}catch(l){l instanceof Error&&l.message==="Failed to fetch"&&rg(l.message)}},mun=async function(b,R,h,K){h||(h=Date.now().toString());
const I=R.channel?.offlineChannelData,N={id:g.Su(R.videoId,"ytMainChannelEntity"),channelId:I.channelId,title:I.title,avatar:I.thumbnail},p={key:g.Su(R.videoId,"mainVideoDownloadStateEntity"),playbackData:g.Su(R.videoId,"playbackData"),addedTimestampMillis:h,videoDownloadContextEntity:g.Su(R.videoId,"videoDownloadContextEntity")},l={key:g.Su(R.videoId,"videoPlaybackPositionEntity"),videoId:R.videoId,lastPlaybackPositionSeconds:"0"};let a;b.QX.N("html5_offline_playback_position_sync")&&(a={playbackPosition:l.key});
h=g.Su(R.videoId,"mainVideoEntity");const v={key:h,videoId:R.videoId,title:R.title,thumbnail:R.thumbnail,localizedStrings:{viewCount:R.shortViewCountText},userState:a,lengthSeconds:R.lengthSeconds?Number(R.lengthSeconds):void 0,publishedTimestampMillis:R.publishedTimestamp?(Number(R.publishedTimestamp)*1E3).toString():void 0,formattedDescription:R.description,owner:N.id,downloadState:p.key};let B,H;b.QX.N("woffle_enable_main_downloads_library")&&K&&(K=await r9U(b.G,[h]))&&(B=K.mainDownloadsLibraryEntity,
H=K.mainDownloadsListEntity);let q;q={key:g.Su(R.videoId,"downloadStatusEntity"),downloadState:"DOWNLOAD_STATE_PENDING_DOWNLOAD"};g.Zq(p,e$R,q);await Yx(b.G,{mode:"readwrite",oT:!0},d=>{var t=EL(d,N,"ytMainChannelEntity"),S=EL(d,p,"mainVideoDownloadStateEntity");const J=EL(d,v,"mainVideoEntity");t=[t,S,J];b.QX.N("html5_offline_playback_position_sync")&&(S=EL(d,l,"videoPlaybackPositionEntity"),t.push(S));B&&(S=EL(d,B,"mainDownloadsLibraryEntity"),t.push(S));H&&(S=EL(d,H,"mainDownloadsListEntity"),
t.push(S));q&&(d=EL(d,q,"downloadStatusEntity"),t.push(d));return g.cL.all(t)});
return{mainVideoEntity:v,channelEntity:N}},ZqU=async function(b,R){const h=Df(R),K=[];
var I=await OZ.getInstance();let N,p;I&&(N=await I.get("sdois"),p=await I?.get("lmqf"));try{if(N===void 0)throw Error("prefStorage or opt-in state is undefined");I=[];N||(I=await MC3(b.G),I.reverse());if(I.length)for(const v of I){if(!v)continue;const B=g.WJ(v).entityId,H=await UZ(b.G,B);H.offlineDeleteReason="OFFLINE_DELETE_REASON_PARENT_LIST_DELETE";await fc(B,b.G,{entityKey:v,actionType:R.actionType},b.X,H)}const l=await IZ3(N,p??"SD");await uwn(l);const a=CqH(l);b.QX.N("woffle_enable_main_downloads_library")&&
(N||await zH(b.G,AG),await i0(b.G,[AG]));if(a?.length)for(const v of a){const B=v.actionType,H=v.entityKey,q=v.actionMetadata;if(B&&H&&q&&!g.Z(q,Pdp)){B==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(q.offlineLoggingData={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});const d=g.Z(v.actionMetadata,D1);d&&(d.playlistId="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS",v.actionMetadata={...v.actionMetadata,mainVideoEntityActionMetadata:d});K.push(v)}}}catch(l){return b="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",
R="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",l instanceof g.QJ&&l.type==="QUOTA_EXCEEDED"&&(b="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",R="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,void 0,b,R)}return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h,K)},ce3=async function(b,R=43200,h=!0){if(!b.D.kV())return[];
let K=[];try{K=await skt(R,h,!1)}catch(I){I instanceof Error&&I.message==="No data"||I instanceof Error&&I.message==="Empty response body"&&rg(I.message)}return z1r(b,K,h,"mainPlaylistEntity")},uN3=async function(b,R,h,K=!1){let I=[];
if(!await $Px()&&!K)return[];h=await NHn(R,h);if(!h?.length)return[];R={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"};for(const p of h){h=p.actionType;var N=p.entityKey;K=p.actionMetadata;h&&N&&K&&!g.Z(K,Pdp)&&(h==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(K.offlineLoggingData=R),{entityId:N}=g.WJ(N),h=await wJ(b,[N],"mainVideoEntity",h,K),I=I.concat(h))}return I},VYR=async function(b,R){const h=Df(R);
var K=g.WJ(R.entityKey).entityId;let I=[];try{I=await XDg(b,K),I?.length&&await SE(b.G,R.entityKey)}catch(p){return R="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",K="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",p instanceof g.QJ&&p.type==="QUOTA_EXCEEDED"&&(R="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",K="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,void 0,R,K)}const N=[];I=await NV(b.G,"musicTrack",I);if(I.length)for(const p of I)b=
p.offlineVideoData,b?.videoId&&N.push(JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",b.videoId,"musicTrack",Number(R.actionMetadata?.priority||0)+1,bB,EZ(R,b,K)));return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h,N)},Cdz=async function(b,R){const h=Df(R);
var K=R.entityKey,I=g.WJ(K).entityId,N=[],p=!1;I==="!*$_ALL_ENTITIES_!*$"?(p=!0,N=await xx(b.G,"musicAlbumRelease")):(K=await Q2(b.G,K,"musicAlbumRelease"))&&N.push(K);if(!N?.length)return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h);if(p){R=[];for(var l of N){var a=g.WJ(l.id).entityId;R.push(JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",a,"musicAlbumRelease",0,bB))}return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h,R)}l=[];N=N[0];p=void 0;N.downloadMetadata&&(p=await Q2(b.G,
N.downloadMetadata,"musicAlbumReleaseDownloadMetadataEntity"),p=Number(p?.addedTimestampMillis??"0")/1E3);try{l=await XDg(b,I,p?.toString())}catch(H){if(H instanceof Error&&H.message==="No data")await gJ(I,"musicAlbumRelease",b.G,R,b.X);else if(H instanceof Error&&H.message==="Empty response body")rg(H.message);else return R="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",a="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",H instanceof g.QJ&&H.type==="QUOTA_EXCEEDED"&&(R="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
a="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,void 0,R,a)}b=[];I=new Map;if(l?.length)for(var v of l)l=v.offlineVideoData,l?.videoId&&I.set(l.videoId,l);v=new Map;l=[];if(N?.tracks?.length)for(var B of N.tracks)if(N=g.WJ(B).entityId)I.has(N)?(v.set(N,I.get(N)),I.delete(N)):l.push(N);B=Number(R.actionMetadata?.priority||0)+1;for(const [H,q]of I.entries())b.push(JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",H,"musicTrack",B,bB,EZ(R,q)));for(const [H,
q]of v.entries())b.push(JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",H,"musicTrack",B,bB,EZ(R,q)));for(a of l)b.push(JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",a,"musicTrack",0,bB));return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h,b)},MYn=async function(b,R){const h=Df(R);
try{const K=g.WJ(R.entityKey).entityId;K==="!*$_ALL_ENTITIES_!*$"?await WU(b.G,R,b.X):(await gJ(K,"musicAlbumRelease",b.G,R,b.X),await nc(b.G,R.entityKey))}catch(K){return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h)},XDg=async function(b,R,h){R=await TH([R]);
b=await reU(b,R[0],h);b=Iw(b.thumbnailDetails);await dJ(b);return R[0].videos},reU=async function(b,R,h){var K=R.additionalMetadadatas;
let I=void 0;if(K&&K.length>0)for(var N of K)if(N.offlineMusicPlaylistData){I=N.offlineMusicPlaylistData;break}K=R.playlistId;const {Bv:p,SO:l}=DZn(R);h=h?(Number(h)*1E3).toString():Date.now().toString();N=R.lastModifiedTimestamp?(Number(R.lastModifiedTimestamp)*1E3).toString():"0";const a={id:g.Su(K,"musicAlbumReleaseDownloadMetadataEntity"),trackDownloadMetadatas:l,lastModifiedTimestampMillis:N,addedTimestampMillis:h,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},v={id:g.Su(K,"musicAlbumRelease"),
title:R.title,audioPlaylistId:K,trackCount:R.totalVideoCount,tracks:p,downloadMetadata:a.id};I&&(v.thumbnailDetails=I.albumHqThumbnail??I.albumArtistThumbnail,v.artistDisplayName=I.albumArtistDisplayName,v.releaseDate=I.albumReleaseDate,v.contentRating={explicitType:I.albumReleaseExplicitType},v.releaseType=I.albumReleaseType);await Yx(b.G,{mode:"readwrite",oT:!0},B=>{const H=EL(B,v,"musicAlbumRelease");B=EL(B,a,"musicAlbumReleaseDownloadMetadataEntity");return g.cL.all([H,B])});
return v},wDg=async function(b,R){const h=Df(R);
var K=g.WJ(R.entityKey).entityId;let I=[];try{I=await LKc(b,K),I?.length&&await SE(b.G,R.entityKey)}catch(p){return R="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",K="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",p instanceof g.QJ&&p.type==="QUOTA_EXCEEDED"&&(R="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",K="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,void 0,R,K)}const N=[];I=await NV(b.G,"musicTrack",I);if(I.length)for(const p of I)b=
p.offlineVideoData,b?.videoId&&N.push(JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",b.videoId,"musicTrack",Number(R.actionMetadata?.priority||0)+1,R9,EZ(R,b,K)));return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h,N)},FKn=async function(b,R){const h=Df(R);
var K=R.entityKey,I=g.WJ(K).entityId,N=[],p=!1;I==="!*$_ALL_ENTITIES_!*$"?(p=!0,N=await xx(b.G,"musicPlaylist")):(K=await Q2(b.G,K,"musicPlaylist"))&&N.push(K);if(!N?.length)return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h);const l=g.Z(R.actionMetadata,bRt)?.autoSync;let a=[],v=!0;K=!0;let B=!1;var H=void 0;if(p||l!==!1){try{a=await pvg(0,!!l,!0,N)}catch(J){J instanceof Error&&J.message==="No data"?I==="!*$_ALL_ENTITIES_!*$"?await WU(b.G,R,b.X):await gJ(I,"musicPlaylist",b.G,R,b.X):J instanceof
Error&&J.message==="Empty response body"&&rg(J.message)}if(!a.length||!p&&a[0].playlistId!==I)return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h)}if(p){R=[];for(var q of a)q.upToDate||l&&!q.shouldAutoSyncMetadata||!q.playlistId||R.push(JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",q.playlistId,"musicPlaylist",0,R9,{musicPlaylistEntityActionMetadata:{autoSync:l}}));return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h,R)}a.length&&(q=a[0],B=!!q.upToDate,l&&(v=q.shouldAutoSyncMetadata??
!0,K=q.shouldAutoSyncVideos??!0,q.checkInSeconds&&(H=q.checkInSeconds)));if(B||!v)return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h);q=[];N=N[0];p=void 0;N.downloadMetadata&&(p=await Q2(b.G,N.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),p=Number(p?.addedTimestampMillis??"0")/1E3);try{q=await LKc(b,I,p?.toString(),H)}catch(J){if(J instanceof Error&&J.message==="No data")await gJ(I,"musicPlaylist",b.G,R,b.X);else if(J instanceof Error&&J.message==="Empty response body")rg(J.message);
else{R="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";var d="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED";J instanceof g.QJ&&J.type==="QUOTA_EXCEEDED"&&(R="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",d="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE");return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,void 0,R,d)}}if(!K)return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h);b=[];I=new Map;if(q?.length)for(var t of q)K=t.offlineVideoData,K?.videoId&&
I.set(K.videoId,K);t=new Map;K=[];if(N?.tracks?.length)for(var S of N.tracks)if(H=g.WJ(S).entityId)I.has(H)?(t.set(H,I.get(H)),I.delete(H)):K.push(H);S=Number(R.actionMetadata?.priority||0)+1;for(const [J,e]of I.entries())b.push(JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",J,"musicTrack",S,R9,EZ(R,e)));for(const [J,e]of t.entries())b.push(JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",J,"musicTrack",S,R9,EZ(R,e)));for(d of K)b.push(JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",d,"musicTrack",0,R9));
return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h,b)},oq2=async function(b,R){const h=Df(R);
try{const K=g.WJ(R.entityKey).entityId;K==="!*$_ALL_ENTITIES_!*$"?await WU(b.G,R,b.X):(await gJ(K,"musicPlaylist",b.G,R,b.X),await nc(b.G,R.entityKey))}catch(K){return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h)},LKc=async function(b,R,h,K){R=await TH([R]);
b=await DuH(b,R[0],h,K);b=Iw(b.thumbnailDetails);await dJ(b);return R[0].videos},DuH=async function(b,R,h,K){const I=R.playlistId,{Bv:N,
SO:p}=DZn(R);h=h?(Number(h)*1E3).toString():Date.now().toString();const l=R.lastModifiedTimestamp?(Number(R.lastModifiedTimestamp)*1E3).toString():"0",a={id:g.Su(I,"musicPlaylistDownloadMetadataEntity"),trackDownloadMetadatas:p,lastModifiedTimestampMillis:l,addedTimestampMillis:h,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},v={id:g.Su(I,"musicPlaylist"),title:R.title,playlistId:I,thumbnailDetails:R.thumbnail,visibility:bVg(R),trackCount:R.totalVideoCount,tracks:N,downloadMetadata:a.id};K&&(v?.entityMetadata?
v.entityMetadata.nextAutoRefreshIntervalSeconds=String(K):v&&(v.entityMetadata={nextAutoRefreshIntervalSeconds:String(K)}));await Yx(b.G,{mode:"readwrite",oT:!0},B=>{const H=EL(B,v,"musicPlaylist");B=EL(B,a,"musicPlaylistDownloadMetadataEntity");return g.cL.all([H,B])});
return v},bVg=function(b){switch(b.privacy){case "PRIVATE":return"PLAYLIST_ENTITY_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_ENTITY_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_ENTITY_VISIBILITY_UNLISTED";default:return"PLAYLIST_ENTITY_VISIBILITY_UNKNOWN"}},Kk3=async function(b,R){const h=Df(R);
var K=g.WJ(R.entityKey).entityId;const I=g.Z(R.actionMetadata,hZ);try{await R5z(b,K,void 0,I?.track,I?.albumRelease),I?.playlistId||await SE(b.G,R.entityKey)}catch(N){return R="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",K="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",N instanceof g.QJ&&N.type==="QUOTA_EXCEEDED"&&(R="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",K="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,
void 0,R,K)}b=(b=g.Z(R.actionMetadata,hZ))?{playbackDataActionMetadata:{maximumDownloadQuality:b.maximumDownloadQuality}}:void 0;R=JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",K,"playbackData",Number(R.actionMetadata?.priority||0)+1,h5z,b);return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h,[R])},six=async function(b,R){const h=Df(R),K=g.WJ(R.entityKey).entityId;
var I=await Q2(b.G,R.entityKey,"musicTrack");const N=I?await Q2(b.G,I.downloadMetadata,"musicTrackDownloadMetadataEntity"):void 0;if(!I||!N)return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h);let p;I=g.Z(R.actionMetadata,hZ);try{await R5z(b,K,N.addedTimestampMillis,I?.track,I?.albumRelease),p=JG("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",K,"playbackData",Number(R.actionMetadata?.priority||0)+1,h5z)}catch(l){if(l instanceof Error&&l.message==="No data")await GH(K,b.G,R,b.X);else if(l instanceof
Error&&l.message==="Empty response body")rg(l.message);else return b="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",R="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",l instanceof g.QJ&&l.type==="QUOTA_EXCEEDED"&&(b="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",R="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,void 0,b,R)}return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h,p?[p]:void 0)},$lz=async function(b,
R){const h=Df(R);
try{const K=g.WJ(R.entityKey).entityId;K==="!*$_ALL_ENTITIES_!*$"?await WU(b.G,R,b.X):(await GH(K,b.G,R,b.X),await nc(b.G,R.entityKey))}catch(K){return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",h,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eE("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",h)},R5z=async function(b,R,h,K,I){K||(K=(await hst([R]))[0],K=o6t(K));
const {musicTrackEntity:N,b$:p}=await IUt(b,K,R,I,h);b=Iw(N.thumbnailDetails);R=[];p&&(R=Iw(p.thumbnailDetails));await dJ(b.concat(R))},IUt=async function(b,R,h,K,I){I||(I=Date.now().toString());
const N={id:g.Su(h,"musicTrackDownloadMetadataEntity"),playbackData:g.Su(h,"playbackData"),addedTimestampMillis:I,videoDownloadContextEntity:g.Su(h,"videoDownloadContextEntity")};K&&(R.albumRelease=K.id);await Yx(b.G,{mode:"readwrite",oT:!0},p=>{const l=[];var a=EL(p,N,"musicTrackDownloadMetadataEntity");l.push(a);a=EL(p,R,"musicTrack");l.push(a);K&&(p=EL(p,K,"musicAlbumRelease"),l.push(p));return g.cL.all(l)});
await Kc(h,"musicTrackDownloadMetadataEntity",b.G,"DOWNLOAD_STATE_PENDING_DOWNLOAD");return{musicTrackEntity:R,b$:K}},NDU=async function(b,R=43200,h=!0){if(!b.D.kV())return[];
let K=[];try{K=await pvg(R,h,!1)}catch(I){}return z1r(b,K,h,"musicPlaylist")},p6n=function(b){let R;
b=g.Z(b.getWatchNextResponse()?.currentVideoEndpoint,g.hw);b?.playlistId&&(R=b.playlistId);return R},lUx=async function(b,R){const h=R.clientPlaybackNonce,K={cpn:h,
offlineSourceVisualElement:g.jU(R.C||"").getAsJson(),selectedOfflineMode:"OFFLINE_NOW",isPartialPlayback:!1};R.Y&&(K.videoFmt=Number(R.Y.itag));R.V&&(K.audioFmt=Number(R.V.itag));const I=p6n(R);var N;if(N=I&&R.videoId)R=R.videoId,N=await (I!=="PPSV"?Promise.resolve(!1):b.G.T6(R));N&&(K.selectedOfflineMode="OFFLINE_MODE_TYPE_AUTO_OFFLINE");b.Y=h;g.yp("offlinePlaybackStarted",K)};
g.Le.prototype.aX=g.hD(42,function(b){return this.app.aX(b)});
g.xR.prototype.aX=g.hD(41,function(b){return g.bnB(this,9,b)});
var KF=class{constructor(b){this.G=b}},sp=class extends KF{get entityMetadata(){return this.G.entityMetadata}set entityMetadata(b){this.G.entityMetadata=b}},aUn=class extends KF{Y(){const b=[];this.G.video&&b.push(this.G.video);return[...(new Set(b))]}},voz=class extends KF{Y(){const b=[];this.G.video&&b.push(this.G.video);this.G.playlist&&b.push(this.G.playlist);this.G.videoItem&&b.push(this.G.videoItem);this.G.playlistItem&&b.push(this.G.playlistItem);return[...(new Set(b))]}},BDz=class extends KF{Y(){const b=
[];this.G.localImageEntities&&b.push(...this.G.localImageEntities);this.G.videoDownloadContextEntity&&b.push(this.G.videoDownloadContextEntity);return[...(new Set(b))]}},HVR=class extends KF{Y(){const b=[];this.G.recommendedVideoMetadata&&b.push(...(new BDz(this.G.recommendedVideoMetadata)).Y());return[...(new Set(b))]}},qsc=class extends KF{Y(){const b=[];this.G.playbackPosition&&b.push(this.G.playbackPosition);return[...(new Set(b))]}},dlp=class extends KF{Y(){const b=[];this.G.creatorEntity&&b.push(this.G.creatorEntity);
return[...(new Set(b))]}},lZ3=["browse","music/browse","streaming_browse","unplugged/browse"],BHH=["offline/playlist_sync_check"],RsR=["offline"],aZR=["offline/offline_video_playback_position_sync"],O8n=["offline/get_playback_data_entity"],OZ=class{constructor(b){this.token=b}static async getInstance(){return new Promise(b=>{g.BW().then(R=>{R?(OZ.instance||(OZ.instance=new OZ(R)),b(OZ.instance)):b(void 0)})})}async get(b){if(b=await (await t4(this.token)).get("prefs",b)){var R=(0,g.c)();
return b.expirationTimestampMs<=R?void 0:b.value}}async set(b,R,h=31536E3){const K=(0,g.c)();b={key:b,value:R,expirationTimestampMs:K+h*1E3};await (await t4(this.token)).put("prefs",b)}async remove(b){await (await t4(this.token)).delete("prefs",b)}},A4,fU3={INVALID_ENCODER_VERSION:"Invalid encoder version",KEY_CREATION_FAILED:"Failed to create encoder key",UNKNOWN_DECODE_ERROR:"Failed to decode PES data",UNKNOWN_ENCODE_ERROR:"Failed to encode PES data",WRONG_DATA_TYPE:"Encoder cannot process the data type"},
ik=class extends g.A${constructor(b,R={}){super(fU3[b],{name:"PESEncoderError",type:b,...R});this.type=b;this.level="WARNING";Object.setPrototypeOf(this,ik.prototype)}},ySH=class{},tXc=class extends ySH{constructor(b){super();this.G=b}X(b,R){R=zA(R);b=(new TextEncoder).encode(JSON.stringify(b));return this.G.encrypt(b,R)}Y(b,R){if(!(b instanceof Uint8Array))throw new ik("WRONG_DATA_TYPE",{EL:1});const h=new TextDecoder;R=zA(R);b=this.G.decrypt(b,R);return JSON.parse(h.decode(b))}},X$z={animationEntity:class extends sp{Y(){return[]}},
accountLinkStatusEntity:class extends sp{Y(){return[]}},booleanEntity:class extends sp{Y(){return[]}},buttonEntity:class extends sp{Y(){return[]}},captionTrack:class extends sp{Y(){return[]}},channelHandle:class extends sp{Y(){return[]}},chatLoadingStateEntity:class extends sp{Y(){return[]}},chipEntity:class extends sp{Y(){return[]}},commerceAcquisitionClientPayloadEntity:class extends sp{Y(){return[]}},commerceCartListEntity:class extends sp{Y(){return[]}},compositeSourceEntity:class extends sp{Y(){return[]}},
multiviewStagingEntity:class extends sp{Y(){const b=[];this.G.compositeSourceKeys&&b.push(...this.G.compositeSourceKeys);return[...(new Set(b))]}},contextNoteFeedEntityPayload:class extends sp{Y(){return[]}},contextNoteUserRatingEntityPayload:class extends sp{Y(){return[]}},continuationTokenEntity:class extends sp{Y(){return[]}},downloadQualityPickerEntity:class extends sp{Y(){return[]}},downloadsPageRefreshTokenEntity:class extends sp{Y(){return[]}},downloadsPageViewConfigurationEntity:class extends sp{Y(){return[]}},
downloadStatusEntity:class extends sp{Y(){return[]}},dismissState:class extends sp{Y(){return[]}},sfvAudioItemCurrentlyPlayingEntity:class extends sp{Y(){return[]}},emojiFountainDataEntity:class extends sp{Y(){return[]}},emojiCustomizationSetEntity:class extends sp{Y(){return[]}},fakeChannel:class extends sp{Y(){const b=[];this.G.alternateChannel&&b.push(this.G.alternateChannel);this.G.alternateChannelList&&b.push(...this.G.alternateChannelList);this.G.oneofChannelEntity&&b.push(this.G.oneofChannelEntity);
return[...(new Set(b))]}},fakePlaylist:class extends sp{Y(){const b=[];this.G.entryCollection&&b.push(this.G.entryCollection);return[...(new Set(b))]}},fakePlaylistEntryCollection:class extends sp{Y(){const b=[];this.G.parentPlaylist&&b.push(this.G.parentPlaylist);if(this.G.entries)for(const R of this.G.entries)b.push(...(new aUn(R)).Y());return[...(new Set(b))]}},fakeVideo:class extends sp{Y(){const b=[];this.G.descriptionEntity&&b.push(this.G.descriptionEntity);this.G.creators&&b.push(...this.G.creators);
this.G.theBiggestFan&&b.push(this.G.theBiggestFan);return[...(new Set(b))]}},fakeVideoDescription:class extends sp{Y(){return[]}},featuredProductsEntity:class extends sp{Y(){return[]}},flowStateEntity:class extends sp{Y(){return[]}},iconBadgeEntity:class extends sp{Y(){return[]}},interstitialInteractionStateEntity:class extends sp{Y(){return[]}},likeButtonAnimationEntity:class extends sp{Y(){return[]}},liveChatPollStateEntity:class extends sp{Y(){return[]}},dataFreshnessEntity:class extends sp{Y(){return[]}},
liveViewerLeaderboardChatEntryPointStateEntity:class extends sp{Y(){return[]}},liveViewerLeaderboardPointsEntity:class extends sp{Y(){return[]}},liveReactionsDataEntity:class extends sp{Y(){return[]}},logoEntity:class extends sp{Y(){return[]}},macroMarkerEntity:class extends sp{Y(){return[]}},mainDownloadsLibraryEntity:class extends sp{Y(){const b=[];this.G.downloadsList&&b.push(this.G.downloadsList);this.G.smartDownloadsList&&b.push(this.G.smartDownloadsList);this.G.recommendedDownloadsList&&b.push(this.G.recommendedDownloadsList);
this.G.refresh&&b.push(this.G.refresh);return[...(new Set(b))]}},mainDownloadsListEntity:class extends sp{Y(){const b=[];this.G.refresh&&b.push(this.G.refresh);if(this.G.downloads)for(const R of this.G.downloads)b.push(...(new voz(R)).Y());return[...(new Set(b))]}},mainPlaylistDownloadStateEntity:class extends sp{Y(){const b=[];this.G.localImageEntities&&b.push(...this.G.localImageEntities);return[...(new Set(b))]}},mainPlaylistEntity:class extends sp{Y(){const b=[];this.G.channelOwner&&b.push(this.G.channelOwner);
this.G.videos&&b.push(...this.G.videos);this.G.collaboratorChannels&&b.push(...this.G.collaboratorChannels);this.G.downloadState&&b.push(this.G.downloadState);this.G.refresh&&b.push(this.G.refresh);return[...(new Set(b))]}},mainPlaylistVideoEntity:class extends sp{Y(){const b=[];this.G.video&&b.push(this.G.video);this.G.channelContributor&&b.push(this.G.channelContributor);return[...(new Set(b))]}},mainVideoDownloadStateEntity:class extends sp{Y(){const b=[];this.G.playbackData&&b.push(this.G.playbackData);
this.G.localImageEntities&&b.push(...this.G.localImageEntities);this.G.videoDownloadContextEntity&&b.push(this.G.videoDownloadContextEntity);return[...(new Set(b))]}},mainVideoEntity:class extends sp{Y(){const b=[];this.G.owner&&b.push(this.G.owner);this.G.downloadState&&b.push(this.G.downloadState);this.G.userState&&b.push(...(new qsc(this.G.userState)).Y());this.G.additionalMetadata&&b.push(...(new HVR(this.G.additionalMetadata)).Y());return[...(new Set(b))]}},markersEngagementPanelSyncEntity:class extends sp{Y(){return[]}},
markersVisibilityOverrideEntity:class extends sp{Y(){return[]}},musicAlbumReleaseDetail:class extends sp{Y(){const b=[];this.G.albumRelease&&b.push(this.G.albumRelease);this.G.tracks&&b.push(...this.G.tracks);return[...(new Set(b))]}},musicAlbumReleaseDownloadMetadataEntity:class extends sp{Y(){const b=[];this.G.trackDownloadMetadatas&&b.push(...this.G.trackDownloadMetadatas);return[...(new Set(b))]}},musicAlbumRelease:class extends sp{Y(){const b=[];this.G.musicLibraryStatusEntity&&b.push(this.G.musicLibraryStatusEntity);
this.G.primaryArtists&&b.push(...this.G.primaryArtists);this.G.details&&b.push(this.G.details);this.G.userDetails&&b.push(this.G.userDetails);this.G.tracks&&b.push(...this.G.tracks);this.G.share&&b.push(this.G.share);this.G.downloadMetadata&&b.push(this.G.downloadMetadata);this.G.refresh&&b.push(this.G.refresh);return[...(new Set(b))]}},musicAlbumReleaseUserDetail:class extends sp{Y(){const b=[];this.G.albumRelease&&b.push(this.G.albumRelease);return[...(new Set(b))]}},musicArtistDetail:class extends sp{Y(){const b=
[];this.G.parentArtist&&b.push(this.G.parentArtist);return[...(new Set(b))]}},musicArtist:class extends sp{Y(){const b=[];this.G.details&&b.push(this.G.details);this.G.userDetails&&b.push(this.G.userDetails);return[...(new Set(b))]}},musicArtistUserDetail:class extends sp{Y(){const b=[];this.G.parentArtist&&b.push(this.G.parentArtist);return[...(new Set(b))]}},musicDownloadsLibraryEntity:class extends sp{Y(){const b=[];this.G.downloadedTracks&&b.push(...this.G.downloadedTracks);this.G.smartDownloadedTracks&&
b.push(...this.G.smartDownloadedTracks);this.G.downloadedEpisodes&&b.push(...this.G.downloadedEpisodes);this.G.downloadedAlbumReleases&&b.push(...this.G.downloadedAlbumReleases);this.G.smartDownloadedAlbumReleases&&b.push(...this.G.smartDownloadedAlbumReleases);this.G.downloadedPlaylists&&b.push(...this.G.downloadedPlaylists);this.G.smartDownloadedPlaylists&&b.push(...this.G.smartDownloadedPlaylists);this.G.metadataOnlyTracks&&b.push(...this.G.metadataOnlyTracks);return[...(new Set(b))]}},musicLibraryEdit:class extends sp{Y(){return[]}},
musicLibraryStatusEntity:class extends sp{Y(){return[]}},musicPlaylist:class extends sp{Y(){const b=[];this.G.tracks&&b.push(...this.G.tracks);this.G.refresh&&b.push(this.G.refresh);this.G.musicLibraryStatusEntity&&b.push(this.G.musicLibraryStatusEntity);this.G.details&&b.push(this.G.details);this.G.downloadMetadata&&b.push(this.G.downloadMetadata);this.G.sideloadMetadata&&b.push(this.G.sideloadMetadata);this.G.userDetails&&b.push(this.G.userDetails);this.G.entryCollection&&b.push(this.G.entryCollection);
this.G.share&&b.push(this.G.share);this.G.podcastShowAdditionalMetadata&&b.push(...(new dlp(this.G.podcastShowAdditionalMetadata)).Y());return[...(new Set(b))]}},musicPlaylistDownloadMetadataEntity:class extends sp{Y(){const b=[];this.G.trackDownloadMetadatas&&b.push(...this.G.trackDownloadMetadatas);return[...(new Set(b))]}},musicShare:class extends sp{Y(){return[]}},musicTrackDetail:class extends sp{Y(){const b=[];this.G.parentTrack&&b.push(this.G.parentTrack);return[...(new Set(b))]}},musicTrackDownloadMetadataEntity:class extends sp{Y(){const b=
[];this.G.playbackData&&b.push(this.G.playbackData);this.G.localImageEntities&&b.push(...this.G.localImageEntities);this.G.videoDownloadContextEntity&&b.push(this.G.videoDownloadContextEntity);return[...(new Set(b))]}},musicTrack:class extends sp{Y(){const b=[];this.G.musicLibraryStatusEntity&&b.push(this.G.musicLibraryStatusEntity);this.G.artists&&b.push(...this.G.artists);this.G.audioModeVersion&&b.push(this.G.audioModeVersion);this.G.videoModeVersion&&b.push(this.G.videoModeVersion);this.G.userDetails&&
b.push(this.G.userDetails);this.G.details&&b.push(this.G.details);this.G.albumRelease&&b.push(this.G.albumRelease);this.G.share&&b.push(this.G.share);this.G.libraryEdit&&b.push(this.G.libraryEdit);this.G.downloadMetadata&&b.push(this.G.downloadMetadata);this.G.playbackPosition&&b.push(this.G.playbackPosition);this.G.lyrics&&b.push(this.G.lyrics);return[...(new Set(b))]}},musicTrackUserDetail:class extends sp{Y(){const b=[];this.G.parentTrack&&b.push(this.G.parentTrack);return[...(new Set(b))]}},offlineOrchestrationActionWrapperEntity:class extends sp{Y(){return[]}},
offlineVideoPolicy:class extends sp{Y(){return[]}},offlineVideoStreams:class extends sp{Y(){return[]}},offlineabilityEntity:class extends sp{Y(){return[]}},orchestrationWebSamplingEntity:class extends sp{Y(){const b=[];this.G.fakeChildren&&b.push(...this.G.fakeChildren);return[...(new Set(b))]}},pageHeaderEntity:class extends sp{Y(){return[]}},pdpStateEntity:class extends sp{Y(){return[]}},pinnedProductEntity:class extends sp{Y(){return[]}},playbackData:class extends sp{Y(){const b=[];this.G.transfer&&
b.push(this.G.transfer);this.G.adsPlaybackData&&b.push(...this.G.adsPlaybackData);this.G.drmLicense&&b.push(this.G.drmLicense);this.G.offlineVideoPolicy&&b.push(this.G.offlineVideoPolicy);this.G.videoDownloadContextEntity&&b.push(this.G.videoDownloadContextEntity);return[...(new Set(b))]}},playerStateEntity:class extends sp{Y(){return[]}},quantityIncrementerEntity:class extends sp{Y(){return[]}},refresh:class extends sp{Y(){return[]}},saveToPlaylistListEntity:class extends sp{Y(){return[]}},selectedChipIndexEntityPayload:class extends sp{Y(){return[]}},
settingEntity:class extends sp{Y(){return[]}},stringEntity:class extends sp{Y(){return[]}},suggestedFeedbackChipStateEntity:class extends sp{Y(){return[]}},transfer:class extends sp{Y(){const b=[];this.G.offlineVideoStreams&&b.push(...this.G.offlineVideoStreams);this.G.captionTrack&&b.push(...this.G.captionTrack);return[...(new Set(b))]}},trendingOfferEntity:class extends sp{Y(){return[]}},videoDownloadContextEntity:class extends sp{Y(){return[]}},videoOverviewAsyncDataEntity:class extends sp{Y(){return[]}},
videoPlaybackPositionEntity:class extends sp{Y(){return[]}},votingEntity:class extends sp{Y(){return[]}},ytMainChannelEntity:class extends sp{Y(){const b=[];this.G.userChannelDetails&&b.push(this.G.userChannelDetails);return[...(new Set(b))]}},youchatPendingResponseEntity:class extends sp{Y(){return[]}},ytMainDownloadedVideoEntity:class extends sp{Y(){const b=[];this.G.video&&b.push(this.G.video);this.G.playbackData&&b.push(this.G.playbackData);this.G.offlineVideoPolicy&&b.push(this.G.offlineVideoPolicy);
return[...(new Set(b))]}},ytMainVideoEntity:class extends sp{Y(){const b=[];this.G.channelOwner&&b.push(this.G.channelOwner);this.G.playbackPosition&&b.push(this.G.playbackPosition);this.G.localImageEntities&&b.push(...this.G.localImageEntities);this.G.downloadStatus&&b.push(this.G.downloadStatus);return[...(new Set(b))]}}},occ=class{constructor(b,R){this.G=b;this.Y=R;this.X={}}},jic=class extends ySH{X(b){return b}Y(b){if(b instanceof Uint8Array)throw new ik("WRONG_DATA_TYPE",{EL:0});return b}},
R$n=class{constructor(){this.G={};this.G[0]=new jic;if(!g.cg("aes_pes_encoder_killswitch")){var b=this.G;try{const K=g.t$();var R=zA(K);var h=new tXc(new g.xh(R),new g.Vr(R))}catch(K){throw b=K instanceof Error?new ik("KEY_CREATION_FAILED",{originalMessage:K.message}):new ik("KEY_CREATION_FAILED"),g.X(b),b;}b[1]=h}}},h$U=class extends g.N3{constructor(b,R){super();this.token=b;this.G=R;this.observers=[];b=new g.JD.BroadcastChannel(`${"PERSISTENT_ENTITY_STORE_SYNC"}:${g.t$()}`);b.onmessage=this.Y.bind(this);
this.channel=b}observe(b){this.observers.push(b);return()=>{const R=this.observers.indexOf(b);R>=0&&this.observers.splice(R,1)}}Y(b){F53(this,b.data)}X5(){this.channel.close()}},mT;var XN3=new g.D("elementsCommand");var jE=new g.D("entityBatchUpdate");var e$R=new g.D("downloadStatusEntity");var WKt=new g.D("mainPlaylistEntityActionMetadata");var D1=new g.D("mainVideoEntityActionMetadata");var bRt=new g.D("musicPlaylistEntityActionMetadata");var hZ=new g.D("musicTrackEntityActionMetadata");var VCz=new g.D("offlineOrchestrationActionCommand");var Pdp=new g.D("localImageEntityActionMetadata");var kV=new g.D("playbackDataActionMetadata");var JVt=new g.D("transferEntityActionMetadata");var iRp=new g.D("videoPlaybackPositionEntityActionMetadata");var fzn=class{constructor(){this.G=new Map}},cV;g.Su("","downloadsPageViewConfigurationEntity");g.Su("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");var AG=g.Su("DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS","mainDownloadsListEntity");g.Su("DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS","refresh");g.Su("SMART_DOWNLOADS_ENABLED","settingEntity");new g.d$;new g.d$;var i8c=class{constructor(){this.locks=navigator.locks}request(b,R={},h){return this.locks.request(b,R,K=>h(K))}};var V2=g.JD.caches,XL,CN,ASR=class{open(b){return V2.open(uk(b))}has(b){return V2.has(uk(b))}delete(b){return V2.delete(uk(b))}async match(b,R){var h=await this.keys();for(const K of h)if(h=await (await this.open(K)).match(b,R))return h}},Gon=class extends ASR{async keys(){const b=[],R=g.t$("CacheStorage keys");var h=await V2.keys();for(const K of h){h=K.indexOf(":");const {WA:I,datasyncId:N}=h===-1?{WA:K}:{WA:K.substring(0,h),datasyncId:K.substring(h+1)};N===R&&b.push(I)}return b}};var iVz=class extends g.N3{constructor(b){super();this.api=b;this.w2={fq9:()=>this.G,
g4X:()=>this.Y};
typeof g.JD.BroadcastChannel!=="undefined"&&(this.G=new g.JD.BroadcastChannel(`${"PLAYER_OFFLINE_ERROR_SYNC"}:${g.t$()}`),this.G.onmessage=this.X.bind(this),this.Y=new g.JD.BroadcastChannel(`${"PLAYER_OFFLINE_PAUSE_SYNC"}:${g.t$()}`),this.Y.onmessage=this.V.bind(this))}X(b){g.rw(this.api,"onOfflineOperationFailure",b.data)}V(b){this.api.publish("offlinetransferpause",b.data)}X5(){this.G?.close();this.Y?.close()}};var z5z=class{constructor(b,R,h){this.K=b;this.U=R;this.visibility=h;this.S=this.D=this.J=this.X=this.G=!1;this.V=new g.bI(()=>{this.p7()});
this.w2={lF:()=>this.Y,
p7:()=>{this.p7()},
J96:()=>this.V};
this.visibility.subscribe("visibilitystatechange",()=>{this.MC()})}MC(){this.G&&wg(this)}p7(){this.Y&&this.Y.resolve();
this.X=this.G=!1;this.U()}};var rVt=["OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"];var aw=class{constructor(b,R,h,K,I=R,N,p,l,a,v,B){this.entityType=b;this.actionId=R;this.action=h;this.parentActionId=K;this.rootActionId=I;this.childActionIds=N;this.prereqActionId=p;this.postreqActionIds=l;this.hasChildActionFailed=v;this.retryScheduleIndex=0;this.G=B||Date.now();this.retryScheduleIndex=a||0}};var c9n="captionTrack downloadStatusEntity ytMainChannelEntity mainPlaylistEntity mainPlaylistDownloadStateEntity mainPlaylistVideoEntity mainVideoEntity mainVideoDownloadStateEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity videoPlaybackPositionEntity".split(" ");var F$R="downloadStatusEntity musicAlbumRelease musicDownloadsLibraryEntity musicPlaylist musicTrack musicTrackDownloadMetadataEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity".split(" ");var $f=class{constructor(b){this.G=b}},eE=class{constructor(b,R,h,K,I,N){this.status=b;this.G=R;this.V=h;this.Y=K;this.X=I;this.downloadState=N}};var Uln=class extends $f{constructor(b,R,h){super(b);this.G=b;this.QX=R;this.X=h}Y(b){return b0(b)?fZ3(this,b):Rw(b)?jkH(this,b):Promise.reject(Error(`Unsupported action type: ${b.actionType}`))}};var G9t=class extends $f{constructor(b,R){super(b);this.G=b;this.QX=R}Y(b){return Rw(b)?AV3(this,b):YuH(b)?zs2(this,b):hG(b)?UPp(this,b):Promise.reject(Error(`Unsupported action type: ${b.actionType}`))}};var goH=class{constructor(b,R){this.api=b;this.G=R;this.logger=new g.kp("woffle");this.Y=!1;this.w2={YB:this.YB}}async V(b){if(b.state.G(128)){const R=b.state.gt;b=R?.errorCode;b=b==="net.connect"&&R?.Zc===1?"TRANSFER_FAILURE_REASON_NETWORK_LOST":b?.startsWith("net.")?"TRANSFER_FAILURE_REASON_NETWORK":"TRANSFER_FAILURE_REASON_INTERNAL";await this.H9(this.player.getVideoData().videoId,b)}}async H9(b,R){this.Y||(this.Y=!0,R==="TRANSFER_FAILURE_REASON_NETWORK_LOST"?mo(this,b,!1,!0):(await xV(this,b),
g.uv(b,4),await this.G.H9(R)))}JB(b){b.status===2?(b.status!==this.X&&(rJ(this.G),g.uv(b.videoId,2)),b.BF&&sHH(this.G,b.videoId,b.BF)):b.status===4?(xV(this,b.videoId),this.H9(b.videoId,b.OJ?"TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":"TRANSFER_FAILURE_REASON_INTERNAL")):b.status===1&&IVt(this.G);this.X=b.status;g.rw(this.api,"localmediachange",{videoId:b.videoId,status:b.status})}async SE(){if(!this.Y){this.Y=!0;var b=this.player.getVideoData().videoId;await xV(this,b);await this.G.SE()}}YB(b){switch(b){case "HD_1080":return"hd1080";
case "HD":return"hd720";case "SD":return"large";case "LD":return"tiny";default:return"hd720"}}N(b){return this.api.L().N(b)}};var Wkr=class extends $f{constructor(b,R){super(b);this.G=b;this.QX=R}Y(b){return b0(b)?n0R(this,b):Rw(b)?E0H(this,b):YuH(b)?TH2(this,b):Promise.reject(Error(`Unsupported action type: ${b.actionType}`))}};var Ssp=class{constructor(){this.actions=[]}G(b,R){let h=b.action.actionMetadata.priority-R.action.actionMetadata.priority;h===0&&(b.G<R.G?h=-1:b.G>R.G&&(h=1));return h}};var xPz=class extends g.N3{constructor(b,R,h,K,I){super();this.Y=b;this.nR=R;this.G6=h;this.D=K;this.QX=I;this.G=new Ssp;this.J=new g.Hi;this.X=new g.bI(()=>{this.retry()});
this.K=NaN;this.S=!1;this.w2={A9e:()=>this.G,
An:()=>this.J,
HTY:()=>this.X,
retry:()=>this.retry()};
g.n(this,this.X);this.U=this.Y.observe(this.C.bind(this))}X5(){this.U&&this.U();super.X5()}createAction(b,R){const h=g.WJ(b.entityKey).entityType,K=g.yM(16);return new aw(h,K,b,R.actionId,R.rootActionId)}async C(b){if(!this.HY()){var R=b.offlineOrchestrationActionWrapperEntity??new Set;b=[];for(var h of R)({entityId:R}=g.WJ(h)),Qk3(this.G,R)||b.push(h);h=await CA3(this,b);await cU(this,h)}}async retry(){await wvH(this)}};var nox=class{constructor(b){this.qJ=b;this.G=void 0}async fN(b,R=!0){if(this.G){var h=[],K=g.bf(this.G.G,R),I=[];for(let N=0;N<K.length;N++)R=this.G.J(K[N],"json3"),R=g.R$(R,{withCredentials:!0,format:"RAW"},3,500).then(p=>{p={metadata:g.g6(K[N]),trackData:p.xhr.responseText};I.push(p)}).xb(p=>{rg("Caption fetch error",p)}),h.push(R);
await OIz(h);try{await azn(b,I)}catch(N){rg("Caption DB transaction error",N)}}}};var Eog=class extends g.N3{constructor(b){super();this.G=b;this.Y=this.G.observe(this.X.bind(this))}X5(){this.Y&&this.Y();super.X5()}async X(b){var R=b.transfer??new Set;b=[];for(const h of R)({entityId:R}=g.WJ(h)),b.push(R);b.length!==0&&await DP2(this,b)}};var tY3=class extends g.N3{constructor(b,R,h,K){super();this.Y=b;this.api=R;this.JX=h;this.C=K;this.J=new g.Hi;this.V=new g.bI(()=>{this.G&&this.G.transferState==="TRANSFER_STATE_TRANSFERRING"&&this.J.kV()&&((this.G.transferRetryCount||0)<3?mo(this.D,this.S,!1,!1):xV(this.D,this.S.videoDetails.videoId),this.H9("TRANSFER_FAILURE_REASON_TIMEOUT_NO_PROGRESS"))});
this.G6=this.MJ=0;this.U=this.K=!1;this.Zr=g.fg(this.api.L().experiments,"html5_transfer_processing_logs_interval");this.vY=new g.Ke(this);this.w2={sk9:()=>this.V,
M6Y:()=>this.C,
An:()=>this.J};
this.nR=this.Y.observe(this.NJ.bind(this));this.D=new goH(R,this);this.pR=new nox(R);this.T6=new Eog(this.Y);this.SY=this.J.listen("publicytnetworkstatus-online",this.Aa.bind(this));this.gp=this.J.listen("publicytnetworkstatus-offline",this.xZ.bind(this));this.U=this.api.L().N("html5_less_transfer_processing_logs");g.n(this,this.vY);this.vY.j(R,"offlinetransferpause",this.KR);if(g.lv(this.api.L()))this.X="mainVideoDownloadStateEntity";else if(g.LW(this.api.L())||g.vG(this.api.L()))this.X="musicTrackDownloadMetadataEntity"}X5(){this.nR&&
this.nR();this.T6.dispose();this.V.dispose();this.SY&&g.fU(this.J.wT,this.SY);this.gp&&g.fU(this.J.wT,this.gp);super.X5()}async KR(b){const R=g.Su(b,"transfer");if(this.G&&R===this.G.key)mo(this.D,this.S,!0),this.V.stop();else{const h=await Yx(this.Y,{mode:"readwrite",oT:!0},K=>gg(K,R,"transfer").then(I=>{if(I&&I.transferState!=="TRANSFER_STATE_COMPLETE"&&I.transferState!=="TRANSFER_STATE_FAILED")return I.transferState="TRANSFER_STATE_PAUSED_BY_USER",EL(K,I,"transfer").then(()=>I)}));
if(h){b&&this.X&&await Kc(b,this.X,this.Y,"DOWNLOAD_STATE_PAUSED");const K=await X9(this,b);J93({videoId:b,qm:h,offlineModeType:K})}}}xZ(){if(this.G&&this.S){mo(this.D,this.S,!1);const b=this.G,R=b?.key?g.WJ(b.key).entityId:"";R&&this.X&&(new Promise((h,K)=>{Kc(R,this.X,this.Y,"DOWNLOAD_STATE_PAUSED").catch(I=>{K(I)})})).catch(h=>{rg("Download state setting error",h)})}this.V.stop()}Aa(){this.G?HqH(this,this.G):MV(this)}async NJ(b){if(this.G&&(this.G.transferState!=="TRANSFER_STATE_COMPLETE"&&this.G.transferState!==
"TRANSFER_STATE_FAILED"&&b.transfer&&b.transfer.has(this.G.key)&&((this.G=await Q2(this.Y,this.G.key,"transfer"))||await qdn(this)),this.G))return;
await MV(this)}async H9(b,R){if(this.G){var h=this.G;const I=h?.key?g.WJ(h.key).entityId:"";a:switch(b){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_PLAYABILITY":case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":var K=!1;break a;default:K=!0}K&&duR(this)?(await u0(this,"TRANSFER_STATE_TRANSFER_IN_QUEUE"),b=await X9(this,I),ou({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_RETRY"},{videoId:I,qm:h,offlineModeType:b}),
I&&this.X&&await Kc(I,this.X,this.Y,"DOWNLOAD_STATE_RETRYABLE_FAILURE")):(await fVn(this,b),I&&this.X&&await Kc(I,this.X,this.Y,"DOWNLOAD_STATE_FAILED"))}else V0(this,`onTransferFailure: ${b}`);Cc(this);h=MV(this,!0);R&&R(h)}async SE(b){if(this.G)if(duR(this)){await u0(this,"TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH");this.G||V0(this,"onMaybeTransferStreamsExpiredRetryAttempting");var R=this.G,h=R?.key?g.WJ(R.key).entityId:"",K=await X9(this,h);ou({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_PLAYER_RESPONSE_EXPIRATION"},
{videoId:h,qm:R,offlineModeType:K});R=l0();g.Zq(R,kV,{isEnqueuedForExpiredStreamUrlRefetch:!0});K=g.Su(h,"playbackData");h=BU(new aw("playbackData",h,{actionType:"OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",entityKey:K,actionMetadata:R}));await e6(this.Y,h,"offlineOrchestrationActionWrapperEntity")}else await fVn(this,"TRANSFER_FAILURE_REASON_STREAM_MISSING"),this.X&&(h=this.G,(h=h?.key?g.WJ(h.key).entityId:"")&&await Kc(h,this.X,this.Y,"DOWNLOAD_STATE_FAILED"));else V0(this,"onMaybeTransferStreamsExpired");
Cc(this);h=MV(this,!0);b&&b(h)}},Lc={TRANSFER_STATE_TRANSFERRING:1,TRANSFER_STATE_TRANSFER_IN_QUEUE:2};var TD2=class{constructor(b,R){this.QX=b;this.api=R;this.D=new g.Hi;this.S=new g.d$;this.w2={lF:()=>this.X.w2.lF(),
An:()=>this.D,
y9R:()=>this.X,
Gr:()=>this.Gr(),
Xw:()=>this.Xw(),
hY:()=>this.hY(),
o7:()=>this.o7(),
He:()=>this.He(),
Sy:h=>this.Sy(h)};
this.X=new z5z(()=>ye3(this),()=>{this.hY()},this.api.SS(),this.api.N.bind(this.api));
this.G=new iVz(this.api);W$z(this.X)}Gr(){return this.S.promise}Xw(){if(this.Y&&this.K)return this.S.promise;Aer(this).then(this.S.resolve).catch(this.S.reject);return this.S.promise}J(b){return{playbackData:new Uln(b,this.QX,this.G),transfer:new Wkr(b,this.QX),videoPlaybackPositionEntity:new G9t(b,this.QX)}}async o7(){this.Y&&await NWH(this.Y)}async hY(){if(this.Y||this.K)await this.Gr(),this.G6!==void 0&&(g.Pg(this.G6),this.G6=void 0),this.V!==void 0&&(g.Pg(this.V),this.V=void 0),this.Y?.dispose(),
this.Y=void 0,this.K?.dispose(),this.K=void 0,g.rw(this.api,"onOrchestrationLostLeader"),this.S=new g.d$}isOrchestrationLeader(){return this.X.G}async T6(){return!1}LQ(b){var R=this.G;R.api.publish("offlinetransferpause",b);R.Y?.postMessage(b)}async Aa(b){const R=await PV();if(R){var h=g.Su(b,"transfer");await Yx(R,{mode:"readwrite",oT:!0},K=>{const I=gg(K,h,"transfer"),N=gg(K,g.Su(b,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.cL.all([I,N]).then(([p,l])=>p&&p.transferState===
"TRANSFER_STATE_PAUSED_BY_USER"?(p.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE",EL(K,p,"transfer").then(()=>{ou({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_USER_RESUME",statusType:"USER_RESUMED"},{videoId:b,qm:p,offlineModeType:l?.offlineModeType});return g.cL.resolve(null)})):g.cL.resolve(null))})}}async nR(b=43200){if(!this.D.kV())return iqr();
var R=await PV();if(!R)return[];const h=Date.now()/1E3;var K=await xx(R,"offlineVideoPolicy");R=[];for(const I of K)Number(I.lastUpdatedTimestampSeconds)+b<=h&&(K=g.WJ(I.key).entityId,R.push(K));return R.length?wJ(this,R,this.C,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"):[]}deleteAll(){return wJ(this,["!*$_ALL_ENTITIES_!*$"],this.C,"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}})}async refreshAllStaleEntities(b){return await this.nR(b)}setUpPositionSyncInterval(b){this.V!==
void 0&&(g.Pg(this.V),this.V=void 0);const R=b??864E5;this.V=g.x_(()=>{this.Sy(R)},R)}async Sy(b){try{const R=await OZ.getInstance();
if(!R)throw Error("prefStorage is undefined");const h=await R.get("psi"),K=h?.oa?Number(h.oa)/1E3:0,I=Date.now();K+b<=I&&await wJ(this,["!*$_ALL_ENTITIES_!*$"],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH")}catch(R){rg("Offline manager error",R)}}async He(){var b=await PV();if(!b)return[];var R=await xx(b,"transfer");b=[];for(const h of R)h.transferState==="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH"&&h.key&&(R=g.WJ(h.key).entityId,b.push(R));return UuH(this,b)}async U(){return[]}async gp(){}async MJ(){}};var JSx=class extends $f{constructor(b,R,h){super(b);this.G=b;this.QX=R;this.X=h}Y(b){return b0(b)?gqp(this,b):Rw(b)?Sdx(this,b):hG(b)?nqn(this,b):Promise.reject(Error(`Unsupported action type: ${b.actionType}`))}},F9=[10];var k93=class extends $f{constructor(b,R,h){super(b);this.G=b;this.QX=R;this.X=h}Y(b){return b0(b)?OqR(this,b):Rw(b)?QHH(this,b):hG(b)?xug(this,b):Promise.reject(Error(`Unsupported action type: ${b.actionType}`))}},e1n=[10];var Ysn=class extends $f{constructor(b,R,h){super(b);this.G=b;this.QX=R;this.X=h}Y(b){return Rw(b)?ZqU(this,b):Promise.reject(Error(`Unsupported action type: ${b.actionType}`))}};var e5n=class extends TD2{constructor(){super(...arguments);this.C="mainVideoEntity"}J(b){const R=super.J(b);R.mainVideoEntity=new k93(b,this.QX,this.G);R.mainPlaylistEntity=new JSx(b,this.QX,this.G);R.mainDownloadsListEntity=new Ysn(b,this.QX,this.G);return R}async refreshAllStaleEntities(b,R){let h=[];this.QX.N("web_player_offline_playlist_auto_refresh")&&(h=await ce3(this,b,R));var K=await OZ.getInstance();const I=await K?.get("sdois");K=await K?.get("lmqf");I&&(h=h.concat(await uN3(this,I,K??
"SD",b===0)));return h=h.concat(await super.refreshAllStaleEntities(b,R))}async T6(b){var R=await PV();if(!R)return!1;R=await Q2(R,AG,"mainDownloadsListEntity");if(R?.downloads?.length){b=g.Su(b,"mainVideoEntity");for(const h of R.downloads)if(h.videoItem===b)return!0}return!1}async U(){var b=await PV();if(!b)return[];var R=await xx(b,"downloadStatusEntity");b=[];for(const h of R)h.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&h.key&&(R=g.WJ(h.key).entityId,b.push(R));return b.length?wJ(this,b,"mainVideoEntity",
"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}}):[]}async MJ(){const b=await PV();b&&await Yx(b,{mode:"readwrite",oT:!0},R=>WV(R,"mainVideoEntity").then(h=>{const K=[];for(const I of h){if(I.userState?.playbackPosition)continue;h=g.WJ(I.key).entityId;h={key:g.Su(h,"videoPlaybackPositionEntity"),videoId:h,lastPlaybackPositionSeconds:"0"};K.push(EL(R,h,"videoPlaybackPositionEntity"));I.userState={playbackPosition:h.key};K.push(EL(R,
I,"mainVideoEntity"))}return g.cL.all(K)}))}async gp(){const b=await PV();
if(b){var R=g.Su("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),h=await Yx(b,{mode:"readonly",oT:!0},H=>g.cL.all([gg(H,R,"mainDownloadsListEntity"),gg(H,AG,"mainDownloadsListEntity"),WV(H,"mainVideoEntity"),WV(H,"mainPlaylistEntity")])),[K,
I,N,p]=h;h=new Set;if(K?.downloads?.length)for(var l of K.downloads){var a=l.videoItem??l.playlistItem;a&&h.add(a)}if(I?.downloads?.length)for(var v of I.downloads)v.videoItem&&h.add(v.videoItem);l=new Set;v=[];for(var B of p){if(B.videos)for(const H of B.videos)(a=JSON.parse(g.WJ(H).entityId).videoId)&&l.add(a);B.key&&!h.has(B.key)&&v.push(B.key)}for(const H of N)H.key&&!h.has(H.key)&&(B=g.WJ(H.key).entityId,l.has(B)||v.push(H.key));v.length&&await i0(b,v)}}};var OVR=class extends $f{constructor(b,R){super(b);this.G=b;this.X=R}Y(b){return b0(b)?VYR(this,b):Rw(b)?Cdz(this,b):hG(b)?MYn(this,b):Promise.reject(Error(`Unsupported action type: ${b.actionType}`))}},bB=[10];var Qiz=class extends $f{constructor(b,R){super(b);this.G=b;this.X=R}Y(b){return b0(b)?wDg(this,b):Rw(b)?FKn(this,b):hG(b)?oq2(this,b):Promise.reject(Error(`Unsupported action type: ${b.actionType}`))}},R9=[10];var xln=class extends $f{constructor(b,R){super(b);this.G=b;this.X=R}Y(b){return b0(b)?Kk3(this,b):Rw(b)?six(this,b):hG(b)?$lz(this,b):Promise.reject(Error(`Unsupported action type: ${b.actionType}`))}},h5z=[10];var mlg=class extends TD2{constructor(){super(...arguments);this.C="musicTrack"}J(b){const R=super.J(b);R.musicTrack=new xln(b,this.G);R.musicPlaylist=new Qiz(b,this.G);R.musicAlbumRelease=new OVR(b,this.G);return R}async refreshAllStaleEntities(b,R){let h=await NDU(this,b,R);return h=h.concat(await super.refreshAllStaleEntities(b,R))}};g.jR("offline",class extends g.AW{constructor(){super(...arguments);this.events=new g.Ke(this);this.QX=this.player.L();this.w2={hBe:()=>this.G,
D9:()=>this.D9(),
b9:b=>this.b9(b)}}create(){g.n(this,this.events);
if(g.lv(this.QX))this.G=new e5n(this.QX,this.player);else if(g.LW(this.QX)||g.vG(this.QX))this.G=new mlg(this.QX,this.player);this.events.j(this.player,"onPlaybackStartExternal",()=>{this.D9()});
this.events.j(this.player,"videodatachange",()=>{this.D9()});
this.QX.N("html5_offline_playback_position_sync")&&this.events.j(this.player,"presentingplayerstatechange",this.b9)}Bd(){return!1}async Y_(b,R,h,K){return this.G?wJ(this.G,b,R,h,K):Promise.reject()}deleteAll(){return this.G.deleteAll()}nR(b){return this.G.nR(b)}refreshAllStaleEntities(b){return this.G.refreshAllStaleEntities(b)}setUpPositionSyncInterval(b){this.G.setUpPositionSyncInterval(b)}LQ(b){this.G.LQ(b)}Aa(b){return this.G.Aa(b)}async D9(){const b=this.player.getVideoData();b.Sn()&&p6n(b)&&
this.Y!==b.clientPlaybackNonce&&await lUx(this,b)}async b9(b){var R=this.player.getVideoData();const h=R.Ty;if(b.Up(2)||b.Up(512))(b=await PV())?(R=R.videoId,await Q2(b,g.Su(R,"mainVideoEntity"),"mainVideoEntity")&&await this.Y_([R],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE",{videoPlaybackPositionEntityActionMetadata:{lastPlaybackPositionSeconds:Math.floor(h).toString()}})):rg("PES is undefined")}isOrchestrationLeader(){return this.G.isOrchestrationLeader()}async updateDownloadState(b,
R){const h=await PV();if(h){var {entityType:K,entityId:I}=g.WJ(b);await Kc(I,K,h,R,!0)}else rg("PES is undefined")}});})(_yt_player);
